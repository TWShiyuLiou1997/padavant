name: Build Single Target (Manual Select)

on: 
  push:
    branches:
    - "*"
  # Ê†∏ÂøÉÔºöËΩâÊèõÁÇ∫ÊâãÂãïÈÅ∏ÊìáÂñÆ‰∏Ä Job ÁöÑËº∏ÂÖ•
  workflow_dispatch:
    inputs:
      # 1. ÈÅ∏ÊìáÁõÆÊ®ôÊ©üÂûã
      target_select:
        description: "Select Target Router Model"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
        default: K2P
        
      # 2. ÈÅ∏Êìá Toolchain
      toolchain_select:
        description: "Select Compilation Toolchain"
        required: true
        type: choice
        options:
          - mipsel-linux-musl # È†êË®≠/ÂéüÁîü Toolchain (‰øùÁïôÂÖßÈÉ®‰∏ãËºâÈÇèËºØ)
          - hanwckf-default
          - turbotse-musl
          - turbotse-uclibc
          - tsl0922-musl
          - tsl0922-uclibc
          - hanwckf-uclibc-v1.1
        default: mipsel-linux-musl
        
      # 3. ÈÅ∏Êìá Nano ÈÅ∏È†Ö
      nanoversion:
        description: "Apply Nano Optimization (Extreme slimming config)"
        type: boolean
        default: false
        
      # 4. ÂÆ¢Ë£ΩÂåñ JSON
      customization:
        description: 'Customization JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      
      # 
      
      - name: ‚öôÔ∏è Set up Go and Node Environments
        run: |
          echo "Setting up Go 1.20 and Node 18.x"
        
      - uses: actions/setup-go@v4
        with:
          go-version: '1.20'
          check-latest: true
          cache: false
          
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          check-latest: true
          
      # ===============================================
      # Ê≠•È©ü 1: ‰æùË≥¥ÂÆâË£ù
      # ===============================================
      - name: üöÄ Install Complete Build Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "--- Êõ¥Êñ∞Â•ó‰ª∂Ê∏ÖÂñÆ‰∏¶ÂÆâË£ùÊâÄÊúâÁ∑®Ë≠Ø‰æùË≥¥ ---"
          sudo apt update
          # Á¢∫‰øù ccache Âú®‰æùË≥¥ÂàóË°®‰∏≠
          sudo apt install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git ccache \
            build-essential fakeroot flex bison gawk gperf \
            autotools-dev autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config jq rsync

          # Ë®≠ÂÆöÂª∫ÁΩÆÊó•ÊúüËÆäÊï∏
          echo "BUILD_DATE=$(TZ='Asia/Taipei' date +%Y%m%d)" >> $GITHUB_ENV

      # ===============================================
      # Ê≠•È©ü 1.5: CCACHE Ë®≠ÂÆö (‰øÆÂæ© /lib/ccache Ê¨äÈôêÂïèÈ°å V8.12)
      # ===============================================
      - name: üíæ Configure ccache (V8.12 Fix)
        run: |
          echo ">>> Setting up ccache to resolve Permission Denied errors at /lib/ccache."
          # 1. Á¢∫‰øù /lib/ccache ÁõÆÈåÑÂ≠òÂú®Ôºå‰∏¶Êéà‰∫à runner Ê¨äÈôê
          sudo mkdir -p /lib/ccache
          sudo chown -R runner:runner /lib/ccache
          # 2. Ë®≠ÂÆö ccache ÈôêÂà∂ÔºàÂèØÈÅ∏Ôºå‰ΩÜÊ®ôÊ∫ñÂÅöÊ≥ïÔºâ
          /usr/bin/ccache -M 10G
          /usr/bin/ccache -o compression=true
          echo "‚úÖ ccache configuration successful."
          
      # ===============================================
      # Ê≠•È©ü 2: Toolchain ‰∏ãËºâËàáÊ∫ñÂÇô (V8.11 ‰øÆÊ≠£: ÊâãÂãïÂ±§Ê¨°‰øÆÊ≠£)
      # ===============================================
      - name: ‚¨áÔ∏è Download and Install External Toolchain (V8.11 Fix:ManualPath)
        # ÂÉÖÂ∞çÈùûÂéüÁîü Toolchain Âü∑Ë°å‰∏ãËºâ
        if: ${{ inputs.toolchain_select != 'mipsel-linux-musl' }}
        env:
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
          TOOLCHAIN_DIR: trunk/toolchain-mipsel/toolchain-4.4.x
        run: |
          echo ">>> Using external URL download logic for $TOOLCHAIN_TAG."
          mkdir -p trunk/toolchain-mipsel

          case "$TOOLCHAIN_TAG" in
            "hanwckf-default")
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.0/mipsel-linux-uclibc.tar.xz"
              ;;
            "turbotse-musl")
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
              ;;
            "turbotse-uclibc")
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz"
              ;;
            "tsl0922-musl")
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
              ;;
            "tsl0922-uclibc")
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz"
              ;;
            "hanwckf-uclibc-v1.1")
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz"
              ;;
            *)
              echo "Error: Unknown toolchain tag: $TOOLCHAIN_TAG."
              exit 1
              ;;
          esac
          
          FILENAME=$(basename "$URL")
          echo "Downloading $FILENAME from $URL"
          curl -o "$FILENAME" -L "$URL"
          
          # Ê∏ÖÁêÜ‰∏¶Ëß£Â£ìÂà∞‰∏ÄÂÄãËá®ÊôÇÁõÆÈåÑ
          TEMP_DIR=$(mktemp -d)
          echo "Extracting to temp directory: $TEMP_DIR"
          sudo tar -xf "$FILENAME" -C "$TEMP_DIR"
          
          # üö® V8.11 ‰øÆÊ≠£ÈÇèËºØÔºöËôïÁêÜÈ°çÂ§ñÁöÑÈ†ÇÂ±§ÁõÆÈåÑ
          TOOLCHAIN_ROOT="$TEMP_DIR"
          
          # Êü•Êâæ TEMP_DIR ‰∏ãÁöÑÊâÄÊúâÂ≠êÁõÆÈåÑ
          VALID_SUBDIRS=()
          for dir in "$TEMP_DIR"/*/; do
              if [ -d "$dir" ]; then
                  VALID_SUBDIRS+=("$dir")
              fi
          done

          # Â¶ÇÊûúÂè™Êúâ‰∏ÄÂÄãÂ≠êÁõÆÈåÑÔºå‰∏îË©≤Â≠êÁõÆÈåÑ‰∏≠ÂåÖÂê´ bin/ÔºåÂâáÈÄ≤ÂÖ•Ë©≤Â≠êÁõÆÈåÑ
          if [ ${#VALID_SUBDIRS[@]} -eq 1 ]; then
              if [ -d "${VALID_SUBDIRS[0]}/bin" ]; then
                  TOOLCHAIN_ROOT="${VALID_SUBDIRS[0]}"
                  echo "Found single subdirectory: ${VALID_SUBDIRS[0]}. Assuming this is the true toolchain root."
              fi
          fi

          # Ê∏ÖÁêÜ‰∏¶Â∞áÊ≠£Á¢∫ÁöÑ Toolchain Ê†πÁõÆÈåÑÁßªÂãïÂà∞È†êÊúü‰ΩçÁΩÆ
          sudo rm -rf "$TOOLCHAIN_DIR"
          sudo mkdir -p "$TOOLCHAIN_DIR"
          
          echo "Moving Toolchain contents from $TOOLCHAIN_ROOT to $TOOLCHAIN_DIR"
          # ‰ΩøÁî® rsync Á¢∫‰øùÊ≠£Á¢∫ÁßªÂãïÂÖßÂÆπ
          sudo rsync -a "$TOOLCHAIN_ROOT"/ "$TOOLCHAIN_DIR"/
          
          # ÊúÄÁµÇÊ™¢Êü• bin ÁõÆÈåÑ
          if [ ! -d "$TOOLCHAIN_DIR/bin" ]; then
              echo "::error:: ‚ùå Toolchain extraction failed: Final target directory $TOOLCHAIN_DIR still does not contain the 'bin' directory."
              exit 1
          fi
          
          # ‰øÆÊ≠£ 1: ÈáçÂëΩÂêç trunk/toolchain/Makefile (ÈÅøÂÖçÂÖßÈÉ®‰∏ãËºâ)
          if [ -f "trunk/toolchain/Makefile" ]; then
              sudo mv trunk/toolchain/Makefile trunk/toolchain/Makefile.bak
              echo ">>> üö® WARNING: Renamed trunk/toolchain/Makefile to prevent internal download conflict."
          fi
          
          echo "‚úÖ External toolchain $TOOLCHAIN_TAG installed successfully at $TOOLCHAIN_DIR."
          rm -rf "$TEMP_DIR"

      - name: üîó Create Toolchain Path and Force Link to /bin (V8.14 Fix: Batch Alias and Syntax)
        if: ${{ inputs.toolchain_select != 'mipsel-linux-musl' }}
        env:
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
        run: |
          TOOLCHAIN_ROOT=trunk/toolchain-mipsel/toolchain-4.4.x
          TOOLCHAIN_SRC=$(pwd)/$TOOLCHAIN_ROOT
          TOOLCHAIN_DST=/toolchain-4.4.x
          
          # 1. Âª∫Á´ã /toolchain-4.4.x ËªüÈÄ£Áµê (Padavan Makefiles È†êÊúüË∑ØÂæë)
          sudo rm -rf $TOOLCHAIN_DST
          sudo ln -s $TOOLCHAIN_SRC $TOOLCHAIN_DST
          
          # üö® Ê™¢Êü• Toolchain Ê†πÁõÆÈåÑÊòØÂê¶Â≠òÂú®
          if [ ! -d "$TOOLCHAIN_SRC" ]; then
              echo "::error:: ‚ùå Toolchain Root Directory $TOOLCHAIN_SRC is missing entirely. Check download step."
              exit 1
          fi
          
          # 2. üö® Ê†∏ÂøÉ‰øÆÊ≠£ÔºöÂ∞á Toolchain ‰∏≠ÁöÑÊâÄÊúâÂü∑Ë°åÊ™îÂº∑Âà∂ËªüÈÄ£ÁµêÂà∞ /bin/ (‰ª•ÂéüÂßãÂêçÁ®±)
          if [ -d "$TOOLCHAIN_SRC/bin" ]; then
              echo ">>> Toolchain bin directory content for inspection:"
              ls -l "$TOOLCHAIN_SRC"/bin/
              echo "----------------------------------------------------"
              
              # ËªüÈÄ£ÁµêÊâÄÊúâ Toolchain ‰∏≠ÁöÑÂü∑Ë°åÊ™îÂà∞ /bin/
              for file in $(ls "$TOOLCHAIN_SRC/bin"); do
                  if [ -x "$TOOLCHAIN_SRC/bin/$file" ] && [ ! -d "$TOOLCHAIN_SRC/bin/$file" ]; then
                      sudo ln -sf "$TOOLCHAIN_SRC/bin/$file" "/bin/$file"
                  fi
              done # <-- V8.14 ‰øÆÊ≠£ÔºöÁ¢∫‰øù for Ëø¥ÂúàÊ≠£Á¢∫ÈóúÈñâ
              
              # 3. üö® V8.13/V8.14 ‰øÆÊ≠£ÔºöÂ∞áÊâÄÊúâÊ®ôÊ∫ñÂêçÁ®± (mipsel-linux-* ) ÈÄ£ÁµêÂà∞ÊúüÊúõÊ®ôÁ±§ÂêçÁ®± ($TOOLCHAIN_TAG-)
              EXPECTED_PREFIX="$TOOLCHAIN_TAG-"
              STANDARD_MUSL_PREFIX="mipsel-linux-musl-"
              STANDARD_UCLIBC_PREFIX="mipsel-linux-uclibc-"
              LINK_FROM=""

              # Âà§Êñ∑ Toolchain ÂØ¶Èöõ‰ΩøÁî®ÁöÑÊ®ôÊ∫ñÂâçÁ∂¥ (musl Êàñ uclibc)
              if ls "$TOOLCHAIN_SRC/bin/$STANDARD_MUSL_PREFIX"* 1> /dev/null 2>&1; then
                  LINK_FROM=$STANDARD_MUSL_PREFIX
                  echo "Identified Toolchain standard prefix: $STANDARD_MUSL_PREFIX"
              elif ls "$TOOLCHAIN_SRC/bin/$STANDARD_UCLIBC_PREFIX"* 1> /dev/null 2>&1; then
                  LINK_FROM=$STANDARD_UCLIBC_PREFIX
                  echo "Identified Toolchain standard prefix: $STANDARD_UCLIBC_PREFIX"
              else
                  echo "::error:: ‚ùå Failed to identify standard toolchain prefix (musl or uclibc) in $TOOLCHAIN_SRC/bin. Batch linking failed."
                  exit 1
              fi

              echo ">>> Creating symlinks for all toolchain executables from '$LINK_FROM' to '$EXPECTED_PREFIX'."
              
              # Ëø≠‰ª£ÊâÄÊúâ‰ª•Ê®ôÊ∫ñÂâçÁ∂¥ÂëΩÂêçÁöÑÊñá‰ª∂ (ÂÆÉÂÄëÂ∑≤Á∂ìÈÄèÈÅéÊ≠•È©ü 2 ÈÄ£ÁµêÂà∞ /bin/)
              for target_path in $(find /bin/ -maxdepth 1 -type f -name "$LINK_FROM*"); do
                  FILENAME=$(basename "$target_path") # ‰æãÂ¶Ç: mipsel-linux-musl-gcc
                  TOOLNAME=${FILENAME#$LINK_FROM}    # ‰æãÂ¶Ç: gcc
                  
                  EXPECTED_NAME="$EXPECTED_PREFIX$TOOLNAME" # ‰æãÂ¶Ç: tsl0922-musl-gcc
                  EXPECTED_PATH="/bin/$EXPECTED_NAME"
                  
                  # Âè™ÊúâÂú®ÁõÆÊ®ôËªüÈÄ£Áµê‰∏çÂ≠òÂú®ÊôÇÊâçÂª∫Á´ã
                  if [ ! -f "$EXPECTED_PATH" ]; then
                      sudo ln -sf "$target_path" "$EXPECTED_PATH"
                  fi
              done
              echo "‚úÖ Batch symlink creation complete."

              # ÊúÄÁµÇÊ™¢Êü•ÊàëÂÄëÈúÄË¶ÅÁöÑÁ∑®Ë≠ØÂô®ÊòØÂê¶Âà∞‰Ωç
              FINAL_CHECK_COMPILER="/bin/${TOOLCHAIN_TAG}-gcc"
              if [ -f "$FINAL_CHECK_COMPILER" ]; then
                  echo "‚úÖ Toolchain fully linked. Compiler $FINAL_CHECK_COMPILER is now ready."
              else
                  echo "::error:: ‚ùå Critical Failure: Compiler $FINAL_CHECK_COMPILER was not found after linking. Please check Toolchain content and structure."
                  exit 1
              fi

          else
              echo "::error:: ‚ùå Toolchain bin directory is missing. Check V8.11 ManualPath logic in step 2."
              exit 1
          fi

      # ===============================================
      # Ê≠•È©ü 3: ÂÆ¢Ë£ΩÂåñË®≠ÂÆö
      # ===============================================
      - name: ‚öôÔ∏è Export Customization Variables
        run: |
          export_json() {
            local JSON=$1
            echo "$JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
              echo "${k^^}=$v" >> $GITHUB_ENV 
            done
          }
          export_json '${{ inputs.customization }}'
          echo "‚úÖ Customization variables exported to environment."

      - name: üìù Execute Customization Scripts
        run: |
          if [ -d "trunk/custom/scripts" ]; then
             chmod +x trunk/custom/scripts/*.sh
             
             bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/src/defaults.h trunk/user/www/dict/CN.dict || true
             bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/src/defaults.h || true
             bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/src/defaults.h || true
             
             echo "‚úÖ Custom settings applied to source code."
          else
             echo "‚ö†Ô∏è Custom scripts folder not found. Skipping customization."
          fi

      # ===============================================
      # Ê≠•È©ü 4: Á∑®Ë≠Ø (Ê†∏ÂøÉËàá Nano Logic)
      # ===============================================
      - name: üèóÔ∏è Build Firmware (Final Makefile Patch & Compile)
        env:
          TNAME: ${{ inputs.target_select }}
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
        run: |
          mkdir -p trunk/images
          
          # 1. ÈÄ≤ÂÖ• trunk ÁõÆÈåÑËôïÁêÜÈÖçÁΩÆÊ™îÊ°à
          cd trunk
          echo "Current directory for config processing: $(pwd)"
          
          NANO_OPT="${{ inputs.nanoversion }}"
          
          # Ë§áË£ΩÈÖçÁΩÆÊ™îÊ°à
          cp -f configs/templates/$TNAME.config .config
          
          # Nano ÂÑ™ÂåñÈÇèËºØ
          if [ "$NANO_OPT" = "true" ]; then
            echo ">>> üö® Applying Nano Optimization for extreme slimming..."
            
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/g' .config

            for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" .config
            done
            
            modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED
              SMBD WINS SMBD_SYSLOG FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN SSWAN
              XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION TRANSMISSION_WEB_CONTROL ARIA QOS
              ARIA_WEB_CONTROL SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT
              SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE LRZSZ HTOP NANO IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY MENTOHUST
              FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER SMARTDNS
              ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER SQM WIREGUARD)
            
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" .config
            done
            
            keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE)
            for mod in "${keep_modules[@]}"; do
              sed -i "/CONFIG_FIRMWARE_INCLUDE_${mod}/d" .config 
              echo "CONFIG_FIRMWARE_INCLUDE_${mod}=y" >> .config
            done

            echo "‚úÖ Nano Optimization applied to .config."
          fi
          
          # 2. üö® ÂàáÊèõÂõûÊ†πÁõÆÈåÑÔºåËÆì make ÊâæÂà∞ Makefile
          cd .. 
          echo "Current directory for compilation: $(pwd)"

          # 3. Ê†∏ÂøÉ‰øÆÊ≠£ÔºöÂãïÊÖã‰øÆÊîπ Makefile (ÁπûÈÅé‰∏ãËºâÈÇèËºØ)
          if [ "$TOOLCHAIN_TAG" != "mipsel-linux-musl" ]; then
              echo ">>> üîß PATCHING: Temporarily removing toolchain build/download logic from main Makefile..."
              
              # ÂÇô‰ªΩ Makefile
              cp Makefile Makefile.bak
              
              # ‰ΩøÁî® sed Âà™Èô§ÊâÄÊúâÂåÖÂê´ 'toolchain' ÈóúÈçµÂ≠óÁöÑË°åÔºå‰ª•Ë∑≥ÈÅé‰∏ãËºâÊ≠•È©ü
              sed -i '/toolchain/d' Makefile
              
              echo "‚úÖ Makefile patched successfully. Running make without toolchain checks."
          fi
          
          # 4. Âü∑Ë°åÁ∑®Ë≠Ø
          make $TNAME TOOLCHAIN=$TOOLCHAIN_TAG
          
          # 5. ÊÅ¢Âæ© Makefile (Â¶ÇÊûúË¢´‰øÆÊîπÈÅé)
          if [ -f Makefile.bak ]; then
              echo ">>> Restoring original Makefile..."
              mv Makefile.bak Makefile
          fi
          
          # ËôïÁêÜËº∏Âá∫Ê™îÊ°àÂêçÁ®±
          OUTPUT_NAME="$TNAME"
          [ "$NANO_OPT" = "true" ] && OUTPUT_NAME="${OUTPUT_NAME}-nano"
          
          # ËôïÁêÜËº∏Âá∫Ê™îÊ°àÂëΩÂêç
          DATE=${{ env.BUILD_DATE }}
          
          # --- Ê™¢Êü•Ëº∏Âá∫Ê™îÊ°à ---
          image=$(ls trunk/images/*.trx 2>/dev/null | head -n 1)
          if [ ! -z "$image" ]; then
             mv "$image" "trunk/images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx"
             echo "‚úÖ Build success for $TNAME. Final image: trunk/images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx"
          else
             echo "::error:: ‚ùå Compilation succeeded but no .trx image was found in trunk/images/."
             exit 1
          fi

      # ‰∏äÂÇ≥ Artifacts
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.target_select }}-${{ inputs.toolchain_select }}-${{ env.BUILD_DATE }}
          path: trunk/images/*.trx

  # ===============================================
  # ÁôºÂ∏É Job
  # ===============================================
  publish:
    needs: [build]
    runs-on: ubuntu-22.04
    # ÂÉÖÂú® main ÂàÜÊîØ push ÊôÇÁôºÂ∏É
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v3
      
      # ‰∏ãËºâ Artifacts
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize Artifacts
        run: |
          mkdir -p release_files
          find artifacts -name "*.trx" -exec cp {} release_files/ \;
          ls -l release_files/
          echo "Found $(ls release_files | wc -l) files for release."

      - name: Set Tag Name
        run: echo "TAG_ANME=$(date +%Y%m%d)" >> $GITHUB_ENV
        
      - uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ env.TAG_ANME }}
          force_push_tag: true
          
      - uses: ncipollo/release-action@v1
        with:
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_ANME }}
          artifacts: "release_files/*.trx"
          allowUpdates: true
