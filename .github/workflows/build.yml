name: Build Single Target (External Toolchain Only)

on:
  # åƒ…æ”¯æ´æ‰‹å‹•è§¸ç™¼ (Manual Select)
  workflow_dispatch:
    inputs:
      target_select:
        description: "Select Target Router Model (e.g., K2P, K2P-NANO)"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
        default: K2P
        
      toolchain_select:
        description: "Select External Compilation Toolchain"
        required: true
        type: choice
        options:
          # ðŸš¨ ç§»é™¤ mipsel-linux-musl (å…§å»º Toolchain)
          - hanwckf-default
          - turbotse-musl
          - turbotse-uclibc
          - tsl0922-musl # æŽ¨è–¦çš„å¤–éƒ¨ Toolchain
          - tsl0922-uclibc
          - hanwckf-uclibc-v1.1
        default: tsl0922-musl 
        
      nanoversion:
        description: "Apply Nano Optimization (Extreme slimming config)"
        type: boolean
        default: false
        
      customization:
        description: 'Customization JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

jobs:
  build:
    runs-on: ubuntu-24.04 # çµ±ä¸€ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç‰ˆæœ¬
    steps:
      - uses: actions/checkout@v3
      
      # ===============================================
      # æ­¥é©Ÿ 1: ç’°å¢ƒæº–å‚™èˆ‡ä¾è³´å®‰è£
      # ===============================================
      - name: 'âš™ï¸ Set up Go and Node Environments' 
        run: echo "Setting up Go 1.20 and Node 18.x"
        
      - uses: actions/setup-go@v4
        with:
          go-version: '1.20'
          check-latest: true
          cache: false
          
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          check-latest: true
          
      - name: 'ðŸš€ Install Complete Build Dependencies' 
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "--- æ›´æ–°å¥—ä»¶æ¸…å–®ä¸¦å®‰è£æ‰€æœ‰ç·¨è­¯ä¾è³´ ---"
          sudo apt update
          sudo apt install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git ccache \
            build-essential fakeroot flex bison gawk gperf \
            autotools-dev autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config jq rsync

          echo "BUILD_DATE=$(TZ='Asia/Taipei' date +%Y%m%d)" >> $GITHUB_ENV

      - name: 'ðŸ’¾ Configure ccache' 
        # ç§»é™¤ ccache-actionï¼Œä½¿ç”¨æ‰‹å‹•é…ç½®é‚è¼¯
        run: |
          echo ">>> Setting up ccache."
          sudo mkdir -p /lib/ccache
          sudo chown -R runner:runner /lib/ccache
          /usr/bin/ccache -M 10G
          /usr/bin/ccache -o compression=true
          echo "âœ… ccache configuration successful."

      # ===============================================
      # æ­¥é©Ÿ 2: å¤–éƒ¨ Toolchain ä¸‹è¼‰èˆ‡é€£çµ (å·²ç§»é™¤æ¢ä»¶åˆ¤æ–·)
      # ===============================================
      - name: 'â¬‡ï¸ Download and Install External Toolchain' 
        env:
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
          TOOLCHAIN_DIR: trunk/toolchain-mipsel/toolchain-4.4.x
        run: |
          echo ">>> Using external URL download logic for $TOOLCHAIN_TAG."
          mkdir -p trunk/toolchain-mipsel

          case "$TOOLCHAIN_TAG" in
            "hanwckf-default") URL="https://github.com/hanwckf/padavan-toolchain/releases/download/linux-4.4-v1.0/mipsel-linux-uclibc.tar.xz" ;;
            "turbotse-musl") URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" ;;
            "turbotse-uclibc") URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" ;;
            "tsl0922-musl") URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" ;;
            "tsl0922-uclibc") URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" ;;
            "hanwckf-uclibc-v1.1") URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz" ;;
            *) echo "Error: Unknown toolchain tag: $TOOLCHAIN_TAG." ; exit 1 ;;
          esac
          
          FILENAME=$(basename "$URL")
          curl -o "$FILENAME" -L "$URL"
          TEMP_DIR=$(mktemp -d)
          sudo tar -xf "$FILENAME" -C "$TEMP_DIR"
          
          TOOLCHAIN_ROOT="$TEMP_DIR"
          # è™•ç†å¯èƒ½çš„å¤šå±¤ç›®éŒ„çµæ§‹ (ä¾‹å¦‚è§£å£“å¾Œåªæœ‰ä¸€å€‹å­ç›®éŒ„)
          VALID_SUBDIRS=($(find "$TEMP_DIR" -maxdepth 1 -type d ! -name "$(basename "$TEMP_DIR")" -print))
          if [ ${#VALID_SUBDIRS[@]} -eq 1 ] && [ -d "${VALID_SUBDIRS[0]}/bin" ]; then
              TOOLCHAIN_ROOT="${VALID_SUBDIRS[0]}"
          fi

          sudo rm -rf "$TOOLCHAIN_DIR"
          sudo mkdir -p "$TOOLCHAIN_DIR"
          sudo cp -r "$TOOLCHAIN_ROOT"/* "$TOOLCHAIN_DIR"/
          sudo chmod -R 755 "$TOOLCHAIN_DIR/bin" 2>/dev/null || true
          
          if [ -f "trunk/toolchain/Makefile" ]; then
              # é¿å…å…§å»º Toolchain çš„ Makefile åŸ·è¡Œä¸‹è¼‰é‚è¼¯
              sudo mv trunk/toolchain/Makefile trunk/toolchain/Makefile.bak
              echo ">>> ðŸš¨ WARNING: Renamed trunk/toolchain/Makefile to prevent internal download conflict."
          fi
          
          echo "âœ… External toolchain $TOOLCHAIN_TAG installed successfully at $TOOLCHAIN_DIR."
          sudo rm -rf "$TEMP_DIR" 

      - name: 'ðŸ”— Create Toolchain Path and Force Link to /bin' 
        env:
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
        run: |
          TOOLCHAIN_SRC=$(pwd)/trunk/toolchain-mipsel/toolchain-4.4.x
          
          if [ ! -d "$TOOLCHAIN_SRC" ] || [ -z "$(ls -A "$TOOLCHAIN_SRC" 2>/dev/null)" ]; then
              echo "::error:: âŒ Toolchain Root Directory is missing or empty."
              exit 1
          fi

          # å»ºç«‹ /toolchain-4.4.x è»Ÿé€£çµ (ä¾›èˆŠç‰ˆ Makefile åƒè€ƒ)
          sudo rm -rf /toolchain-4.4.x
          sudo ln -s "$TOOLCHAIN_SRC" /toolchain-4.4.x
          
          if [ -d "$TOOLCHAIN_SRC/bin" ]; then
              # æ‰¾å‡º Toolchain çš„åŽŸå§‹å‰ç¶´ (e.g., mipsel-linux-musl-)
              if ls "$TOOLCHAIN_SRC/bin/"*-gcc 1> /dev/null 2>&1; then
                  # æ‰¾åˆ°ç¬¬ä¸€å€‹ -gcc åŸ·è¡Œæª”ï¼Œæ“·å–å…¶å‰ç¶´
                  LINK_FROM=$(ls "$TOOLCHAIN_SRC/bin/"*-gcc | head -n 1 | xargs basename | sed 's/-gcc//')
                  LINK_FROM="${LINK_FROM}-"
              else
                  echo "::error:: âŒ Could not determine original toolchain prefix."
                  exit 1
              fi
              
              EXPECTED_PREFIX="${TOOLCHAIN_TAG}-" # e.g., tsl0922-musl-

              find "$TOOLCHAIN_SRC/bin" -maxdepth 1 -type f -name "$LINK_FROM*" | while read -r target_path_original; do
                  FILENAME=$(basename "$target_path_original")
                  TOOLNAME=${FILENAME#$LINK_FROM}
                  EXPECTED_NAME="$EXPECTED_PREFIX$TOOLNAME"
                  
                  # é€£çµåˆ° /bin/mipsel-linux-musl-gcc (åŽŸå)
                  sudo ln -sf "$target_path_original" "/bin/$FILENAME" 
                  
                  # é€£çµåˆ° /bin/tsl0922-musl-gcc (æ–°åï¼Œä¾›ç·¨è­¯ä½¿ç”¨)
                  if [ ! -f "/bin/$EXPECTED_NAME" ]; then
                      sudo ln -sf "/bin/$FILENAME" "/bin/$EXPECTED_NAME" 
                  fi
              done
              echo "âœ… Toolchain linked to /bin/ successfully."
          else
              echo "::error:: âŒ Toolchain bin directory is missing."
              exit 1
          fi

      # ===============================================
      # æ­¥é©Ÿ 3: å®¢è£½åŒ–èˆ‡é…ç½®
      # ===============================================
      - name: 'âš™ï¸ Export Customization Variables' 
        run: |
          export_json() {
            local JSON=$1
            echo "$JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
              echo "${k^^}=$v" >> $GITHUB_ENV 
            done
          }
          export_json '${{ inputs.customization }}'
          echo "Customization variables exported to environment."

      - name: 'ðŸ“ Execute Customization Scripts' 
        # ä½¿ç”¨ç¬¬äºŒå€‹è…³æœ¬ä¸­å·²é©—è­‰çš„å®¢è£½åŒ–é‚è¼¯
        run: |
          if [ -d "trunk/custom/scripts" ]; then
              chmod +x trunk/custom/scripts/*.sh
              bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/src/defaults.h trunk/user/www/dict/CN.dict || true
              bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/src/defaults.h || true
              bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/src/defaults.h || true
              echo "âœ… Custom settings applied to source code."
          else
              echo "âš ï¸ Custom scripts folder not found. Skipping customization."
          fi

      - name: 'ðŸ“ CORE:Configuration and Nano Optimization' 
        # æ•´åˆç¬¬äºŒå€‹è…³æœ¬ä¸­å·²é©—è­‰çš„é…ç½®å’Œ Nano é‚è¼¯
        env:
          TNAME: ${{ inputs.target_select }}
          NANO_OPT: ${{ inputs.nanoversion }}
        run: |
          cd trunk
          
          # 1. è¤‡è£½é…ç½®æª”æ¡ˆåˆ° trunk/.config
          echo ">>> 1. Copying base config: $TNAME.config -> .config"
          cp -f configs/templates/$TNAME.config .config
          
          # 2. åŸ·è¡Œæ¥µç«¯ Nano å„ªåŒ– (ä½¿ç”¨å·²é©—è­‰çš„æ¨¡çµ„åˆ—è¡¨)
          if [ "$NANO_OPT" = "true" ]; then
            echo ">>> ðŸš¨ Applying Nano Optimization for extreme slimming (Configuration only)..."
            for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" .config
            done
            
            modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED
              SMBD WINS SMBD_SYSLOG FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN SSWAN
              XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION TRANSMISSION_WEB_CONTROL ARIA QOS
              ARIA_WEB_CONTROL SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT
              SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE LRZSZ HTOP NANO IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY MENTOHUST
              FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER SMARTDNS
              ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER SQM WIREGUARD)
            
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" .config
            done
            
            keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE)
            for mod in "${keep_modules[@]}"; do
              sed -i "/CONFIG_FIRMWARE_INCLUDE_${mod}/d" .config
              echo "CONFIG_FIRMWARE_INCLUDE_${mod}=y" >> .config
            done
            echo "âœ… Extreme Nano Optimization configuration applied."
          fi
          
          cd ..

      # ===============================================
      # æ­¥é©Ÿ 4: Host Tools ç·¨è­¯
      # ===============================================
      - name: 'ðŸ”¨ Pre-Build Host Tools (Fix mkimage bug)'
        # ä½¿ç”¨ç¬¬äºŒå€‹è…³æœ¬ä¸­å·²é©—è­‰çš„ Host Tools ç·¨è­¯é‚è¼¯ (å« mkimage è£œä¸)
        run: |
          echo ">>> ðŸ—ï¸ Building Host Tools..."
          cd trunk
          
          # ðŸš¨ mkimage.c çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²éŒ¯èª¤ä¿®å¾©
          if [ -f "tools/mkimage/mkimage.c" ]; then
              echo ">>> ðŸ”§ Patching tools/mkimage/mkimage.c..."
              sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' tools/mkimage/mkimage.c
              sed -i 's/"%d\.%d%c"/"%hhd.%hhd%c"/g' tools/mkimage/mkimage.c
              echo "âœ… mkimage.c patched."
          fi

          make -C tools clean || true
          make -C tools
          echo "âœ… Host tools built successfully."
          cd ..

      # ===============================================
      # æ­¥é©Ÿ 5: å›ºä»¶ç·¨è­¯å‰æº–å‚™ (è¨­å®šç’°å¢ƒè®Šæ•¸å’Œ Makefile ä¿®è£œ)
      # ===============================================
      - name: 'ðŸ—ï¸ Configure and Set Environment (Set Toolchain Vars)' 
        env:
          TNAME: ${{ inputs.target_select }}
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
        run: |
          
          # 1. BusyBox Makefile ä¿®è£œ (ç§»é™¤ EXTRA_LIBS)
          BUSYBOX_MAKEFILE="trunk/user/busybox/Makefile"
          if [ -f "$BUSYBOX_MAKEFILE" ]; then
            echo ">>> ðŸ”§ Patching $BUSYBOX_MAKEFILE (Removing EXTRA_LIBS)..."
            cp "$BUSYBOX_MAKEFILE" "$BUSYBOX_MAKEFILE.bak"
            sed -i '/EXTRA_LIBS =/c\EXTRA_LIBS =' "$BUSYBOX_MAKEFILE"
            echo "âœ… BusyBox Makefile patched."
          fi

          # 2. é ‚å±¤ Makefile ä¿®è£œ (ç§»é™¤ toolchain ä¸‹è¼‰é‚è¼¯)
          echo ">>> ðŸ”§ PATCHING: Temporarily removing toolchain build/download logic from main Makefile..."
          cp Makefile Makefile.bak
          sed -i '/toolchain/d' Makefile
          echo "âœ… Makefile patched successfully."
          
          # 3. è¨­å®šäº¤å‰ç·¨è­¯ç’°å¢ƒè®Šæ•¸
          echo ">>> ðŸ› ï¸ Setting Toolchain environment variables for FIRMWARE build."
          
          TOOLCHAIN_ROOT=$(pwd)/trunk/toolchain-mipsel/toolchain-4.4.x
          TOOLCHAIN_BIN="/bin" # å› ç‚ºæˆ‘å€‘å·²ç¶“è»Ÿé€£çµåˆ° /bin
          
          GCC_PATH="$TOOLCHAIN_TAG-gcc" # e.g., tsl0922-musl-gcc
          
          # å°‹æ‰¾ Sysroot è·¯å¾‘
          SYSROOT_DIR=$(find "$TOOLCHAIN_ROOT" -maxdepth 3 -type d -name "sysroot" | head -n 1)
          
          if [ -z "$SYSROOT_DIR" ] || [ ! -d "$SYSROOT_DIR" ]; then
              echo "::error:: âŒ Critical Failure: Could not locate Sysroot directory."
              exit 1
          fi
          
          # å°Žå‡º CROSS_COMPILE ç›¸é—œè®Šæ•¸åˆ° $GITHUB_ENV
          echo "LDFLAGS=-Wl,--sysroot=$SYSROOT_DIR" >> $GITHUB_ENV
          echo "CC=$TOOLCHAIN_BIN/$GCC_PATH" >> $GITHUB_ENV
          echo "CXX=$TOOLCHAIN_BIN/${TOOLCHAIN_TAG}-g++" >> $GITHUB_ENV
          echo "LD=$TOOLCHAIN_BIN/${TOOLCHAIN_TAG}-ld" >> $GITHUB_ENV
          echo "AS=$TOOLCHAIN_BIN/${TOOLCHAIN_TAG}-as" >> $GITHUB_ENV
          echo "CROSS_COMPILE=${TOOLCHAIN_TAG}-" >> $GITHUB_ENV
          echo "BUSYBOX_CC=$TOOLCHAIN_BIN/$GCC_PATH" >> $GITHUB_ENV
          
          # å°Žå‡º Go ç’°å¢ƒè®Šæ•¸
          echo "GOOS=linux" >> $GITHUB_ENV
          echo "GOARCH=mipsle" >> $GITHUB_ENV
          echo "CGO_ENABLED=1" >> $GITHUB_ENV

          echo "âœ… Environment ready. Sysroot: $SYSROOT_DIR"
          echo "âœ… Toolchain variables exported to environment."

      # ===============================================
      # æ­¥é©Ÿ 6: å›ºä»¶ç·¨è­¯èˆ‡æ¸…ç†
      # ===============================================
      - name: 'ðŸš€ Execute Firmware Build (Use Exported Environment)'
        # ä½¿ç”¨ä¸Šä¸€æ­¥é©ŸåŒ¯å‡ºçš„ç’°å¢ƒè®Šæ•¸ (åœ¨ shell ç’°å¢ƒä¸­è‡ªå‹•ç”Ÿæ•ˆ)
        env:
          TNAME: ${{ inputs.target_select }}
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
        run: |
          echo ">>> ðŸš€ Starting Final Build: make $TNAME TOOLCHAIN=$TOOLCHAIN_TAG"
          # åœ¨é ‚å±¤ç›®éŒ„åŸ·è¡Œ make K2P
          make $TNAME
          # æ³¨æ„ï¼šç”±æ–¼æˆ‘å€‘å·²ç¶“åœ¨ç’°å¢ƒä¸­è¨­ç½®äº† CC, LDFLAGS, CROSS_COMPILE ç­‰è®Šæ•¸ï¼Œ
          # é ‚å±¤ make æ‡‰è©²èƒ½æ­£ç¢ºæ‰¾åˆ°ç·¨è­¯å™¨ä¸¦å•Ÿå‹•æµç¨‹ã€‚

          # æ¢å¾©é ‚å±¤ Makefile
          if [ -f Makefile.bak ]; then 
             echo ">>> Restoring original Makefile..."
             mv Makefile.bak Makefile
          fi

          # æ¢å¾© BusyBox Makefile
          BUSYBOX_MAKEFILE="trunk/user/busybox/Makefile"
          if [ -f "$BUSYBOX_MAKEFILE.bak" ]; then 
             echo ">>> Restoring BusyBox Makefile..."
             mv "$BUSYBOX_MAKEFILE.bak" "$BUSYBOX_MAKEFILE"
          fi
          
          # æª¢æŸ¥ä¸¦é‡å‘½åå›ºä»¶ (ä½¿ç”¨ç¬¬äºŒå€‹è…³æœ¬ä¸­å·²é©—è­‰çš„é‚è¼¯)
          OUTPUT_NAME="$TNAME"
          [ "${{ inputs.nanoversion }}" = "true" ] && OUTPUT_NAME="${OUTPUT_NAME}-nano"
          DATE=${{ env.BUILD_DATE }}
          
          image=$(ls trunk/images/*.trx 2>/dev/null | head -n 1)
          if [ ! -z "$image" ]; then
              # è§£æ±º Permission denied
              sudo mv "$image" "trunk/images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx"
              echo "âœ… Build success. Final image: trunk/images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx"
          else
              echo "::error:: âŒ Compilation succeeded but no .trx image was found in trunk/images/."
              exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.target_select }}-${{ inputs.toolchain_select }}-${{ env.BUILD_DATE }}
          path: trunk/images/*.trx

  # ===============================================
  # æ­¥é©Ÿ 7: ç™¼ä½ˆ
  # ===============================================
  publish:
    needs: [build]
    runs-on: ubuntu-24.04
    permissions: 
      contents: write 
    
    if: ${{ github.ref == 'refs/heads/main' }} 
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: 'Organize Artifacts' 
        run: |
          mkdir -p release_files
          find artifacts -name "*.trx" -exec cp {} release_files/ \;
          ls -l release_files/
      - name: 'Set Tag Name' 
        run: echo "TAG_ANME=$(date +%Y%m%d)-${{ github.run_number }}" >> $GITHUB_ENV
      - uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ env.TAG_ANME }}
          force_push_tag: true
      - uses: ncipollo/release-action@v1
        with:
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_ANME }}
          artifacts: "release_files/*.trx"
          allowUpdates: true
