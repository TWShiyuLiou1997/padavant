name: Custom Padavan Build (Matrix Toolchain & Nano Logic)

on: 
  push:
    branches:
    - "*"
  # å…è¨±æ‰‹å‹•è§¸ç™¼ï¼Œä¸¦å¯å‚³å…¥å®¢è£½åŒ–åƒæ•¸å’Œ Nano é¸é …
  workflow_dispatch:
    inputs:
      nanoversion:
        description: "Apply Nano Optimization (Extreme slimming config)"
        type: boolean
        default: false
        
      customization:
        description: 'Customization JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        target: [K2P, K2P-NANO, K2P-USB]
        # ðŸš¨ Toolchain é¸é …ï¼šåŒ…å«åŽŸå§‹çš„ mipsel-linux-musl å’Œé¡å¤–çš„ 6 å€‹ã€‚
        toolchain_tag:
          - mipsel-linux-musl # åŽŸå§‹è…³æœ¬çš„é¸é …ï¼Œå°‡ä¾è³´ make åŸ·è¡Œæ™‚è™•ç†/ä¸‹è¼‰
          - hanwckf-default
          - turbotse-musl
          - turbotse-uclibc
          - tsl0922-musl
          - tsl0922-uclibc
          - hanwckf-uclibc-v1.1
          
    steps:
      - uses: actions/checkout@v3
      
      # ðŸš¨ [ä¿®æ­£] ccache Key ç´å…¥ toolchain_tag
      - uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.target }}-${{ matrix.toolchain_tag }}
          
      - uses: actions/setup-go@v4
        with:
          go-version: '1.20'
          check-latest: true
          cache: false
          
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          check-latest: true
          
      # ===============================================
      # æ­¥é©Ÿ 1: ä¾è³´å®‰è£
      # ===============================================
      - name: Prepare (Fix Dependencies)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git \
            build-essential fakeroot flex bison gawk gperf \
            autotools-dev autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq

          # è¨­å®šå»ºç½®æ—¥æœŸè®Šæ•¸
          echo "BUILD_DATE=$(TZ='Asia/Taipei' date +%Y%m%d)" >> $GITHUB_ENV

      # ===============================================
      # æ­¥é©Ÿ 2: Toolchain ä¸‹è¼‰èˆ‡æº–å‚™ (åªè™•ç†å¤–éƒ¨ Toolchain)
      # ===============================================
      - name: â¬‡ï¸ Download and Install External Toolchain (If not mipsel-linux-musl)
        if: ${{ matrix.toolchain_tag != 'mipsel-linux-musl' }}
        env:
          TOOLCHAIN_TAG: ${{ matrix.toolchain_tag }}
          TOOLCHAIN_DIR: trunk/toolchain-mipsel/toolchain-4.4.x
        run: |
          echo ">>> Using external URL download logic for $TOOLCHAIN_TAG."
          mkdir -p trunk/toolchain-mipsel

          case "$TOOLCHAIN_TAG" in
            "hanwckf-default")
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.0/mipsel-linux-uclibc.tar.xz"
              ;;
            "turbotse-musl")
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
              ;;
            "turbotse-uclibc")
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz"
              ;;
            "tsl0922-musl")
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
              ;;
            "tsl0922-uclibc")
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz"
              ;;
            "hanwckf-uclibc-v1.1")
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz"
              ;;
            *)
              echo "Error: Unknown toolchain tag: $TOOLCHAIN_TAG."
              exit 1
              ;;
          esac
          
          FILENAME=$(basename "$URL")
          echo "Downloading $FILENAME from $URL"
          curl -o "$FILENAME" -L "$URL"
          
          # æ¸…ç†ä¸¦è§£å£“åˆ° Padavan å°ˆæ¡ˆé æœŸçš„ä½ç½®
          sudo rm -rf "$TOOLCHAIN_DIR"
          sudo mkdir -p "$TOOLCHAIN_DIR"
          sudo tar -xf "$FILENAME" -C "$TOOLCHAIN_DIR" --strip-components=1
          
          echo "âœ… External toolchain $TOOLCHAIN_TAG installed successfully."

      # ðŸ”´ è»Ÿé€£çµæ­¥é©Ÿï¼šå°æ–¼å¤–éƒ¨ Toolchainï¼Œå¿…é ˆå»ºç«‹æ­¤è»Ÿé€£çµï¼›å°æ–¼ mipsel-linux-muslï¼Œè®“ make è™•ç†
      - name: ðŸ”— Create Toolchain Path Link (Required for external toolchains)
        if: ${{ matrix.toolchain_tag != 'mipsel-linux-musl' }}
        run: |
          TOOLCHAIN_SRC=trunk/toolchain-mipsel/toolchain-4.4.x
          TOOLCHAIN_DST=/toolchain-4.4.x
          
          sudo rm -rf $TOOLCHAIN_DST
          # å»ºç«‹æ­£ç¢ºçš„è»Ÿé€£çµ
          sudo ln -s $(pwd)/$TOOLCHAIN_SRC $TOOLCHAIN_DST
          
          if [ -d "$TOOLCHAIN_DST/bin" ]; then
              echo "âœ… Toolchain path successfully linked for external: $TOOLCHAIN_DST -> $TOOLCHAIN_SRC"
          else
              echo "::error:: âŒ Toolchain link failed or toolchain not properly extracted. Check step 2."
              exit 1
          fi

      # ===============================================
      # æ­¥é©Ÿ 3: å®¢è£½åŒ–è¨­å®š (ä¿æŒæ‚¨çš„é‚è¼¯)
      # ===============================================
      - name: Export Customization Variables
        if: github.event_name == 'workflow_dispatch'
        run: |
          export_json() {
            local JSON=$1
            echo "$JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
              echo "${k^^}=$v" >> $GITHUB_ENV
            done
          }
          export_json '${{ inputs.customization }}'
          echo "Customization variables exported to environment."

      - name: Execute Customization Scripts
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ -d "trunk/custom/scripts" ]; then
             chmod +x trunk/custom/scripts/*.sh
             
             bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/src/defaults.h trunk/user/www/dict/CN.dict || true
             bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/src/defaults.h || true
             bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/src/defaults.h || true
             
             echo "âœ… Custom settings applied to source code."
          else
             echo "âš ï¸ Custom scripts folder not found. Skipping customization."
          fi

      # ===============================================
      # æ­¥é©Ÿ 4: ç·¨è­¯ (æ ¸å¿ƒèˆ‡ Nano Logic)
      # ===============================================
      - name: ðŸ—ï¸ Build Firmware (${{ matrix.target }} with ${{ matrix.toolchain_tag }})
        env:
          TNAME: ${{ matrix.target }}
        run: |
          mkdir -p trunk/images
          cd trunk
          NANO_OPT="${{ github.event.inputs.nanoversion || 'false' }}" # è®€å– Nano è¼¸å…¥
          
          # è¤‡è£½é…ç½®æª”æ¡ˆ
          cp -f configs/templates/$TNAME.config .config
          
          # ðŸš¨ Nano å„ªåŒ–é‚è¼¯ (ä¿ç•™æ‚¨æä¾›çš„è©³ç´°é‚è¼¯)
          if [ "$NANO_OPT" = "true" ]; then
            echo ">>> ðŸš¨ Applying Nano Optimization for extreme slimming..."
            
            # ç¢ºä¿åŸºæœ¬åŠŸèƒ½ OPENSSL_EXE é–‹å•Ÿ
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/g' .config

            # ç§»é™¤æ–‡ä»¶ç³»çµ±æ”¯æŒ
            for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" .config
            done
            
            # ç§»é™¤å¤§é‡æ¨¡çµ„
            modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED
              SMBD WINS SMBD_SYSLOG FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN SSWAN
              XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION TRANSMISSION_WEB_CONTROL ARIA QOS
              ARIA_WEB_CONTROL SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT
              SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE LRZSZ HTOP NANO IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY MENTOHUST
              FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER SMARTDNS
              ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER SQM WIREGUARD)
            
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" .config
            done
            
            # ç¢ºä¿ä¿ç•™æ¨¡çµ„
            keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE)
            for mod in "${keep_modules[@]}"; do
              sed -i "/CONFIG_FIRMWARE_INCLUDE_${mod}/d" .config 
              echo "CONFIG_FIRMWARE_INCLUDE_${mod}=y" >> .config
            done

            echo "âœ… Nano Optimization applied to .config."
          fi
          
          # ðŸš¨ æ ¸å¿ƒï¼šä¿ç•™æ‚¨åŽŸå§‹è…³æœ¬çš„ç·¨è­¯èª¿ç”¨æ–¹å¼
          # å°æ–¼ mipsel-linux-muslï¼Œmake æœƒè‡ªå‹•è™•ç†ä¸‹è¼‰å’Œè·¯å¾‘
          # å°æ–¼å…¶ä»– Toolchainï¼Œæˆ‘å€‘åœ¨å‰ä¸€æ­¥å·²ç¶“ä¸‹è¼‰ä¸¦æº–å‚™å¥½è·¯å¾‘
          make $TNAME TOOLCHAIN=${{ matrix.toolchain_tag }}
          
          # è™•ç†è¼¸å‡ºæª”æ¡ˆåç¨±
          OUTPUT_NAME="$TNAME"
          [ "$NANO_OPT" = "true" ] && OUTPUT_NAME="${OUTPUT_NAME}-nano"
          
          # è™•ç†è¼¸å‡ºæª”æ¡ˆå‘½å (åŒ…å« Toolchain Tag)
          image=$(ls images/*.trx 2>/dev/null | head -n 1)
          if [ ! -z "$image" ]; then
             mv $image images/${OUTPUT_NAME}-${{ matrix.toolchain_tag }}-${{ env.BUILD_DATE }}.trx
          fi
          
          echo "âœ… Build success for $TNAME."

      # ðŸš¨ [ä¿®æ­£] å‡ç´šåˆ° actions/upload-artifact@v4
      - uses: actions/upload-artifact@v4
        with:
          # ä½¿ç”¨ä¸€å€‹åŒ…å« target å’Œ toolchain çš„å”¯ä¸€åç¨±
          name: ${{ matrix.target }}-${{ matrix.toolchain_tag }}-${{ env.BUILD_DATE }}
          path: trunk/images/*.trx

  # ===============================================
  # ç™¼å¸ƒ Job (ä¿®æ­£ Artifact ç‰ˆæœ¬)
  # ===============================================
  publish:
    needs: [build]
    runs-on: ubuntu-22.04
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v3
      
      # ðŸš¨ [ä¿®æ­£] å‡ç´šåˆ° actions/download-artifact@v4
      - uses: actions/download-artifact@v4
        with:
          # ä¸‹è¼‰æ‰€æœ‰æ§‹å»ºç”¢ç‰©
          path: artifacts

      - name: Organize Artifacts
        run: |
          mkdir -p release_files
          # å°‡æ‰€æœ‰ä¸‹è¼‰çš„ .trx æ–‡ä»¶é›†ä¸­åˆ°ä¸€å€‹ç›®éŒ„
          find artifacts -name "*.trx" -exec cp {} release_files/ \;
          ls -l release_files/

      - name: Set Tag Name
        run: echo "TAG_ANME=$(date +%Y%m%d)" >> $GITHUB_ENV
        
      - uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ env.TAG_ANME }}
          force_push_tag: true
          
      - uses: ncipollo/release-action@v1
        with:
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_ANME }}
          # ç™¼å¸ƒ release_files/ ä¸­çš„æ‰€æœ‰ .trx æ–‡ä»¶
          artifacts: "release_files/*.trx"
          allowUpdates: true
