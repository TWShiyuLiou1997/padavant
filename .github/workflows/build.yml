name: Build Single Target (V8.46 Fix)

on:
  workflow_dispatch:
    inputs:
      target_select:
        description: "Select Target Router Model"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
        default: K2P
        
      toolchain_select:
        description: "Select Compilation Toolchain"
        required: true
        type: choice
        options:
          - mipsel-linux-musl    # å…§éƒ¨æ¨¡å¼ï¼šäº¤çµ¦æºç¢¼ Makefile è‡ªå‹•è™•ç†
          - hanwckf-default      # å¤–éƒ¨æ¨¡å¼ï¼šæ‰‹å‹•ä¸‹è¼‰ + è»Ÿé€£çµ
          - turbotse-musl
          - turbotse-uclibc
          - tsl0922-musl
          - tsl0922-uclibc
          - hanwckf-uclibc-v1.1
        default: mipsel-linux-musl 
        
      nanoversion:
        description: "Apply Nano Optimization"
        type: boolean
        default: false
        
      customization:
        description: 'Customization JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      
      # ===============================================
      # 1. ç’°å¢ƒæº–å‚™ (ä¿æŒæ‚¨é©—è­‰éŽçš„æˆåŠŸé…ç½®)
      # ===============================================
      - uses: actions/setup-go@v4
        with:
          go-version: '1.20'
          check-latest: true
          cache: false
          
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: 'ðŸš€ Install Dependencies' 
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git \
            build-essential fakeroot flex bison gawk gperf \
            autotools-dev autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq
          
          # è¨­ç½® Go ç’°å¢ƒè®Šæ•¸ (é¿å… Xray ç·¨è­¯éŒ¯èª¤)
          echo "GOOS=linux" >> $GITHUB_ENV
          echo "GOARCH=mipsle" >> $GITHUB_ENV
          echo "GOMIPS=softfloat" >> $GITHUB_ENV
          echo "BUILD_DATE=$(TZ='Asia/Taipei' date +%Y%m%d)" >> $GITHUB_ENV

      - name: 'ðŸ’¾ Configure ccache' 
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ inputs.target_select }}-${{ inputs.toolchain_select }}

      # ===============================================
      # 2. Toolchain è™•ç† (V8.46 åˆ†æµé‚è¼¯)
      # ===============================================
      - name: 'ðŸ”§ Prepare Toolchain (Dual Strategy)'
        env:
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
        run: |
          echo ">>> Current Toolchain Selection: $TOOLCHAIN_TAG"
          
          # -----------------------------------------------
          # æƒ…æ³ A: å…§éƒ¨ Toolchain (mipsel-linux-musl)
          # -----------------------------------------------
          if [ "$TOOLCHAIN_TAG" == "mipsel-linux-musl" ]; then
            echo ">>> [Mode A] Internal Toolchain selected."
            echo ">>> We will NOT touch the Makefile or download anything."
            echo ">>> The 'make' command later will handle crosstool-ng automatically."
            # ç¢ºä¿ç›®éŒ„ä¹¾æ·¨
            rm -rf trunk/toolchain-mipsel/toolchain-4.4.x
            exit 0
          fi

          # -----------------------------------------------
          # æƒ…æ³ B: å¤–éƒ¨ Toolchain (å›žåˆ°èˆŠç‰ˆä¸‹è¼‰+è»Ÿé€£çµé‚è¼¯)
          # -----------------------------------------------
          echo ">>> [Mode B] External Toolchain selected. Executing manual setup..."
          
          # 1. é˜²æ­¢ä¸» Makefile åŸ·è¡Œå…§éƒ¨ä¸‹è¼‰ (è§£æ±º 404 éŒ¯èª¤çš„é—œéµ!)
          echo ">>> ðŸ”§ Patching trunk/Makefile to SKIP internal toolchain build..."
          # å°‡ "build: toolchain" æ›¿æ›ç‚º "build: " (ç§»é™¤ä¾è³´)
          # æˆ–è€…è¨»è§£æŽ‰ toolchain ç›¸é—œçš„æŒ‡ä»¤
          if [ -f trunk/Makefile ]; then
             sed -i 's/^build: toolchain/build:/g' trunk/Makefile
             sed -i '/make -C toolchain/d' trunk/Makefile
             echo "âœ… trunk/Makefile patched."
          fi

          # 2. ä¸‹è¼‰ Toolchain
          mkdir -p trunk/toolchain-mipsel
          case "$TOOLCHAIN_TAG" in
            "hanwckf-default") URL="https://github.com/hanwckf/padavan-toolchain/releases/download/linux-4.4-v1.0/mipsel-linux-uclibc.tar.xz" ;;
            "turbotse-musl")   URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" ;;
            "turbotse-uclibc") URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" ;;
            "tsl0922-musl")    URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" ;;
            "tsl0922-uclibc")  URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" ;;
            "hanwckf-uclibc-v1.1") URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz" ;;
            *) echo "Error: Unknown toolchain"; exit 1 ;;
          esac

          echo "Downloading: $URL"
          curl -fSsLo toolchain.tar.xz "$URL"
          
          TEMP_DIR=$(mktemp -d)
          tar -xf toolchain.tar.xz -C "$TEMP_DIR"
          
          # å°‹æ‰¾è§£å£“å¾Œçš„æ ¹ç›®éŒ„
          TOOLCHAIN_ROOT=""
          if [ -d "$TEMP_DIR/bin" ]; then
             TOOLCHAIN_ROOT="$TEMP_DIR"
          else
             SUBDIR=$(find "$TEMP_DIR" -maxdepth 1 -type d ! -name "$(basename "$TEMP_DIR")" | head -n 1)
             if [ -n "$SUBDIR" ]; then TOOLCHAIN_ROOT="$SUBDIR"; fi
          fi

          if [ -z "$TOOLCHAIN_ROOT" ]; then
             echo "::error:: Failed to locate toolchain bin directory."
             exit 1
          fi

          # ç§»å‹•åˆ°æ¨™æº–ä½ç½®
          TARGET_DIR="$(pwd)/trunk/toolchain-mipsel/toolchain-4.4.x"
          mkdir -p "$(dirname "$TARGET_DIR")"
          rm -rf "$TARGET_DIR"
          mv "$TOOLCHAIN_ROOT" "$TARGET_DIR"
          
          # 3. æ¢å¾©èˆŠç‰ˆè»Ÿé€£çµé‚è¼¯ (Link to /bin)
          echo ">>> ðŸ”— Creating symlinks in /bin (Legacy Mode)..."
          
          # å»ºç«‹ /toolchain-4.4.x å…¼å®¹é€£çµ
          sudo rm -rf /toolchain-4.4.x
          sudo ln -s "$TARGET_DIR" /toolchain-4.4.x

          # è­˜åˆ¥ Toolchain å…§éƒ¨çš„å‰ç¶´ (å¦‚ mipsel-linux-musl-)
          if ls "$TARGET_DIR/bin/mipsel-linux-musl-gcc" 1> /dev/null 2>&1; then
              LINK_FROM="mipsel-linux-musl-"
          elif ls "$TARGET_DIR/bin/mipsel-linux-uclibc-gcc" 1> /dev/null 2>&1; then
              LINK_FROM="mipsel-linux-uclibc-"
          else
              # è‡ªå‹•åµæ¸¬
              LINK_FROM=$(ls "$TARGET_DIR/bin/"*-gcc | head -n 1 | xargs basename | sed 's/-gcc//')
              LINK_FROM="${LINK_FROM}-"
          fi
          
          EXPECTED_PREFIX="${TOOLCHAIN_TAG}-"
          echo ">>> Linking binaries: Internal($LINK_FROM) -> System(/bin/$EXPECTED_PREFIX)"

          # éæ­· bin ç›®éŒ„ä¸¦å»ºç«‹é€£çµ
          find "$TARGET_DIR/bin" -maxdepth 1 -type f -name "$LINK_FROM*" | while read -r src_path; do
              FILENAME=$(basename "$src_path")
              SUFFIX=${FILENAME#$LINK_FROM}         # e.g., gcc
              TARGET_NAME="$EXPECTED_PREFIX$SUFFIX"  # e.g., tsl0922-musl-gcc
              
              # é€£çµ 1: ç¢ºä¿åŽŸå§‹åç¨±åœ¨ /bin å¯ç”¨ (éƒ¨åˆ† script å¯èƒ½å¯«æ­»)
              sudo ln -sf "$src_path" "/bin/$FILENAME"
              
              # é€£çµ 2: ç¢ºä¿ Makefile æŒ‡å®šçš„åç¨± (TOOLCHAIN_TAG) å¯ç”¨
              if [ "$FILENAME" != "$TARGET_NAME" ]; then
                  sudo ln -sf "$src_path" "/bin/$TARGET_NAME"
              fi
          done
          
          echo "âœ… External toolchain setup complete."

      - name: 'ðŸ“ Customization & Configuration' 
        env:
          TNAME: ${{ inputs.target_select }}
        run: |
          # å°Žå‡º JSON è®Šæ•¸
          echo '${{ inputs.customization }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
              echo "${k^^}=$v" >> $GITHUB_ENV
          done
          
          # åŸ·è¡Œå®¢è£½åŒ–è…³æœ¬
          if [ -d "trunk/custom/scripts" ]; then
              chmod +x trunk/custom/scripts/*.sh
          fi
          
          # è¤‡è£½è¨­å®šæª”
          cd trunk
          if [ ! -f configs/templates/$TNAME.config ]; then
             echo "::error:: Config for $TNAME not found."
             exit 1
          fi
          cp -f configs/templates/$TNAME.config .config
          
          # Nano å„ªåŒ–
          if [ "${{ inputs.nanoversion }}" = "true" ]; then
            echo ">>> Applying Nano Optimization..."
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/g' .config
            for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" .config
            done
            modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED
              SMBD WINS SMBD_SYSLOG FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN SSWAN
              XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION TRANSMISSION_WEB_CONTROL ARIA QOS
              ARIA_CONTROL SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT
              SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE LRZSZ HTOP NANO IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY MENTOHUST
              FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER SMARTDNS
              ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER SQM WIREGUARD)
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" .config
            done
            keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE)
            for mod in "${keep_modules[@]}"; do
              sed -i "/CONFIG_FIRMWARE_INCLUDE_${mod}/d" .config 
              echo "CONFIG_FIRMWARE_INCLUDE_${mod}=y" >> .config
            done
          fi
          
          # ä¿®æ­£ BusyBox Makefile (ç§»é™¤ EXTRA_LIBS)
          if [ -f "user/busybox/Makefile" ]; then
             sed -i '/EXTRA_LIBS =/c\EXTRA_LIBS =' user/busybox/Makefile
          fi

      - name: 'ðŸš€ Build Firmware'
        id: build_step
        env:
          TNAME: ${{ inputs.target_select }}
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
        run: |
          # æ‡‰ç”¨å®¢è£½åŒ–è¨­å®š
          if [ -d "trunk/custom/scripts" ]; then
             bash trunk/custom/scripts/setip.sh "${LANIP}" trunk/user/shared/src/defaults.h trunk/user/www/dict/CN.dict || true
             bash trunk/custom/scripts/setaccount.sh "${SIGNACCOUNT}" "${SIGNPASSWORD}" trunk/user/shared/src/defaults.h || true
             bash trunk/custom/scripts/setwifi.sh "${WIFI2GSSID}" "${WIFI2GPSK}" "${WIFI5GSSID}" "${WIFI5GPSK}" trunk/user/shared/src/defaults.h || true
          fi

          echo ">>> Building $TNAME with toolchain $TOOLCHAIN_TAG"
          
          # åŸ·è¡Œ Make
          # æ³¨æ„ï¼šå¦‚æžœæ˜¯ mipsel-linux-muslï¼ŒMakefile æœƒè§¸ç™¼ä¸‹è¼‰
          # æ³¨æ„ï¼šå¦‚æžœæ˜¯å¤–éƒ¨ Toolchainï¼Œæˆ‘å€‘ä¸Šé¢å·²ç¶“ Patch éŽ Makefileï¼Œé€™è£¡æœƒç›´æŽ¥é–‹å§‹ç·¨è­¯ä»£ç¢¼
          make $TNAME TOOLCHAIN=$TOOLCHAIN_TAG
          
          # è™•ç†ç”¢ç‰©
          OUTPUT_NAME="$TNAME"
          [ "${{ inputs.nanoversion }}" = "true" ] && OUTPUT_NAME="${OUTPUT_NAME}-nano"
          
          image=$(ls trunk/images/*.trx 2>/dev/null | head -n 1)
          if [ ! -z "$image" ]; then
              FINAL_NAME="${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${{ env.BUILD_DATE }}.trx"
              mv "$image" "trunk/images/$FINAL_NAME"
              echo "âœ… Build success: trunk/images/$FINAL_NAME"
          else
              echo "::error:: Build finished but no .trx image found."
              exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.target_select }}-${{ inputs.toolchain_select }}-${{ env.BUILD_DATE }}
          path: trunk/images/*.trx

  publish:
    needs: [build]
    runs-on: ubuntu-22.04
    permissions: 
      contents: write 
    if: ${{ github.ref == 'refs/heads/main' }} 
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: 'Organize Artifacts' 
        run: |
          mkdir -p release_files
          find artifacts -name "*.trx" -exec cp {} release_files/ \;
      - name: 'Set Tag' 
        run: echo "TAG_ANME=$(date +%Y%m%d)-${{ github.run_number }}" >> $GITHUB_ENV
      - uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ env.TAG_ANME }}
      - uses: ncipollo/release-action@v1
        with:
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_ANME }}
          artifacts: "release_files/*.trx"
          allowUpdates: true
