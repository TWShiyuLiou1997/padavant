name: build

on:
  push:
    branches:
      - "*"
  # æ•´åˆ Script 2 çš„æ‰‹å‹•è§¸ç™¼åƒæ•¸
  workflow_dispatch:
    inputs:
      nanoversion:
        description: "Force Nano Version (Apply extreme slimming config)"
        type: boolean
        default: false
      
      customization:
        description: 'Customization JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'
      
      toolchain_select:
        description: "Select Compilation Toolchain"
        required: true
        type: choice
        options:
          - Default (hanwckf/linux-4.4-v1.0, uclibc)
          - TurboTse/musl (gcc 13.3.0, musl 1.2.5)
          - TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)
          - tsl0922/musl (gcc 13.2.0, musl 1.2.4)
          - tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)
          - hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32, SO_REUSEPORT patch)
        default: Default (hanwckf/linux-4.4-v1.0, uclibc)

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # ä¿ç•™ Script 1 çš„å¤šç›®æ¨™çŸ©é™£
        target: [K2P, K2P-NANO, K2P-USB]
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Sync to Opt Directory
        # ç‚ºäº†å…¼å®¹ Script 2 çš„ç¡¬ç·¨ç¢¼è·¯å¾‘é‚è¼¯ï¼Œå°‡ä»£ç¢¼è¤‡è£½åˆ° /opt/rt-n56u
        run: |
          sudo mkdir -p /opt/rt-n56u
          sudo cp -rf ./* /opt/rt-n56u/
          echo "Workspace synced to /opt/rt-n56u"

      - name: ğŸš€ Install Complete Build Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git \
            build-essential fakeroot flex bison gawk gperf \
            libtool-bin libltdl-dev python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq

      - name: ğŸ’¾ Set up ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.target }}-${{ inputs.toolchain_select }}

      - name: âš™ï¸ Set up Go Environment
        uses: actions/setup-go@v4
        with:
          go-version: '1.24.x' # å‡ç´šè‡³ Script 2 çš„å»ºè­°ç‰ˆæœ¬
          check-latest: true
          cache: false 

      - name: âš™ï¸ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          check-latest: true

      # === Script 2 åŠŸèƒ½ï¼šJSON è®Šæ•¸è™•ç† ===
      - name: ğŸ” Validate and Export Customization
        if: github.event_name == 'workflow_dispatch'
        run: |
          jq empty <<< '${{ inputs.customization }}' || { echo "âŒ Invalid customization JSON"; exit 1; }
          export_json() {
            local JSON=$1
            echo "$JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
              echo "${k^^}=$v" >> $GITHUB_ENV
            done
          }
          export_json '${{ inputs.customization }}'

      # === Script 2 åŠŸèƒ½ï¼šå·¥å…·éˆä¸‹è¼‰èˆ‡ä¿®å¾© ===
      - name: â¬‡ï¸ Prepare and Download Selected Toolchain
        env:
          TOOLCHAIN_CHOICE: ${{ inputs.toolchain_select || 'Default (hanwckf/linux-4.4-v1.0, uclibc)' }}
          TOOLCHAIN_DIR: /opt/rt-n56u/toolchain-mipsel/toolchain-4.4.x
        run: |
          cd /opt/rt-n56u/toolchain-mipsel
          
          # æ¸…ç†èˆŠç›®éŒ„
          rm -rf "$TOOLCHAIN_DIR"
          
          case "$TOOLCHAIN_CHOICE" in
            "Default (hanwckf/linux-4.4-v1.0, uclibc)")
              sh dl_toolchain.sh
              # ä¿éšªèµ·è¦‹çš„æ‰‹å‹•æª¢æŸ¥
              if [ ! -d "$TOOLCHAIN_DIR" ] && [ -f "mipsel-linux-uclibc.tar.xz" ]; then
                  mkdir -p "$TOOLCHAIN_DIR"
                  tar -xf "mipsel-linux-uclibc.tar.xz" -C "$TOOLCHAIN_DIR" --strip-components=1
              fi
              ;;
            "TurboTse/musl (gcc 13.3.0, musl 1.2.5)")
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" ;;
            "TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)")
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" ;;
            "tsl0922/musl (gcc 13.2.0, musl 1.2.4)")
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" ;;
            "tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)")
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" ;;
            "hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32, SO_REUSEPORT patch)")
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz" ;;
            *)
              echo "Using Default or Unknown choice, relying on repo defaults." ;;
          esac
          
          if [ ! -z "$URL" ]; then
            curl -O -L "$URL"
            mkdir -p "$TOOLCHAIN_DIR"
            tar -xf $(basename "$URL") -C "$TOOLCHAIN_DIR" --strip-components=1
            echo "Toolchain installed from $URL"
          fi

      - name: ğŸ”— Fix Toolchain Path Link
        run: |
          # é€™æ˜¯ Script 2 æœ€æ ¸å¿ƒçš„ä¿®å¾©ï¼šå»ºç«‹è»Ÿé€£çµ
          sudo rm -rf /toolchain-4.4.x
          sudo ln -s /opt/rt-n56u/toolchain-mipsel/toolchain-4.4.x /toolchain-4.4.x
          
          if [ -d "/toolchain-4.4.x/bin" ]; then
             echo "âœ… Toolchain path successfully linked."
          else
             echo "::error:: âŒ Toolchain link failed."
             exit 1
          fi

      # === Script 2 åŠŸèƒ½ï¼šæ‡‰ç”¨å®¢è£½åŒ–è…³æœ¬ ===
      - name: ğŸ“ Apply Customization to Source Files
        if: github.event_name == 'workflow_dispatch'
        run: |
          cd /opt/rt-n56u
          chmod +x trunk/custom/scripts/*.sh || echo "No custom scripts found, skipping chmod"
          
          # æª¢æŸ¥è…³æœ¬æ˜¯å¦å­˜åœ¨å†åŸ·è¡Œ
          if [ -f "trunk/custom/scripts/setip.sh" ]; then
             bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/src/defaults.h trunk/user/www/dict/CN.dict
             bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/src/defaults.h
             bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/src/defaults.h
             echo "âœ… Customizations applied."
          else
             echo "âš ï¸ Custom scripts not found in repository. Skipping customization."
          fi

      # === æ•´åˆå¾Œçš„ç·¨è­¯æ­¥é©Ÿ ===
      - name: Build Firmware
        run: |
          cd /opt/rt-n56u/trunk
          
          TNAME="${{ matrix.target }}"
          # åˆ¤æ–·æ˜¯å¦å•Ÿç”¨ Nano å„ªåŒ–ï¼šå¦‚æœ Matrix æ˜¯ K2P-NANO æˆ–è€… Input å‹¾é¸äº† Nano
          INPUT_NANO="${{ inputs.nanoversion }}"
          if [[ "$TNAME" == *"NANO"* ]] || [[ "$INPUT_NANO" == "true" ]]; then
            IS_NANO="true"
          else
            IS_NANO="false"
          fi
          
          # æª¢æŸ¥ä¸¦è¤‡è£½è¨­å®šæª”
          if [ ! -f configs/templates/$TNAME.config ] ; then
             echo "::error:: Config configs/templates/$TNAME.config not found."
             exit 1
          fi
          cp -f configs/templates/$TNAME.config .config
          
          # åŸºç¤ä¿®æ”¹
          sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/g' .config
          
          # æ‡‰ç”¨ Script 2 çš„ Nano æ¥µé™å„ªåŒ–é‚è¼¯
          if [ "$IS_NANO" = "true" ]; then
             echo ">>> ğŸš¨ Applying Nano Optimization..."
             # ç§»é™¤æ–‡ä»¶ç³»çµ±
             for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
               sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" .config
             done
             # ç§»é™¤å¤§é‡æ¨¡çµ„ (ç²¾ç°¡ç‰ˆåˆ—è¡¨)
             modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED \
               SMBD WINS FTPD RPL2TP EAP_PEAP DROPBEAR_FAST_CODE OPENVPN SSWAN \
               MINIDLNA FFMPEG_NEW TRANSMISSION ARIA QOS MENTOHUST \
               SHADOWSOCKS XRAY V2RAY TROJAN ADBYBY SMARTDNS WIREGUARD)
             for mod in "${modules[@]}"; do
               sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" .config
             done
             echo "âœ… Nano config applied."
          fi
          
          # æ¸…ç†ä¸¦ç·¨è­¯
          sudo ./clear_tree
          # å˜—è©¦ä½¿ç”¨ Script 2 çš„ build_firmware_modifyï¼Œå¦‚æœä¸å­˜åœ¨å‰‡å›é€€åˆ° make
          if [ -f "./build_firmware_modify" ]; then
             sudo ./build_firmware_modify $TNAME 0
          else
             echo "build_firmware_modify script not found, falling back to make."
             make $TNAME
          fi
          
          # æ•´ç†ç”¢ç‰©ï¼Œæº–å‚™ä¸Šå‚³
          # Script 1 é æœŸç”¢ç‰©åœ¨ trunk/images/*.trx
          # é€™è£¡æˆ‘å€‘ç¢ºä¿ç”¢ç‰©åç¨±æ¸…æ™°
          image_path=$(ls images/*.trx 2>/dev/null | head -n 1)
          if [ ! -z "$image_path" ]; then
             echo "Build successful: $image_path"
          else
             echo "::error:: No image found after build."
             exit 1
          fi

      - uses: actions/upload-artifact@master
        with:
          # ä½¿ç”¨çŸ©é™£åç¨±ä½œç‚º artifact åç¨±ï¼Œé¿å…è¡çª
          name: firmware-${{ matrix.target }}
          path: /opt/rt-n56u/trunk/images/*.trx

  publish:
    needs: [build]
    runs-on: ubuntu-22.04
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          path: artifacts
          
      - name: Organize Artifacts
        run: |
          mkdir -p release_files
          # å°‡ä¸‹è¼‰çš„æ‰€æœ‰ artifact ç§»å‹•åˆ°ä¸€å€‹æ–‡ä»¶å¤¾ä¾›ç™¼å¸ƒ
          find artifacts -name "*.trx" -exec cp {} release_files/ \;
          ls -R release_files

      - name: Set Tag Name
        run: echo "TAG_ANME=$(date +%Y%m%d)" >> $GITHUB_ENV
      
      - uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ env.TAG_ANME }}
          force_push_tag: true
      
      - uses: ncipollo/release-action@v1
        with:
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_ANME }}
          artifacts: "release_files/*.trx"
          allowUpdates: true
