name: Build Single Target (External Toolchain Only)

on:
  # å…è¨±æ‰‹å‹•è§¸ç™¼ä¸¦é¸æ“‡ç·¨è­¯ç›®æ¨™èˆ‡å·¥å…·éˆ
  workflow_dispatch:
    inputs:
      target_select:
        description: "Select Target Router Model (e.g., K2P, K2P-NANO)"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
        default: K2P
        
      toolchain_select:
        description: "Select EXTERNAL Compilation Toolchain"
        required: true
        type: choice
        options:
          - hanwckf-default
          - turbotse-musl
          - turbotse-uclibc
          - tsl0922-musl # Recommended External Toolchain
          - tsl0922-uclibc
          - hanwckf-uclibc-v1.1
        default: tsl0922-musl
        
      nanoversion:
        description: "Apply Nano Optimization (Extreme slimming config)"
        type: boolean
        default: false
        
      customization:
        description: 'Customization JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

jobs:
  build:
    # çµ±ä¸€ä½¿ç”¨ Ubuntu 22.04 LTS
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      
      # ===============================================
      # æ­¥é©Ÿ 0: ç’°å¢ƒè¨­å®šèˆ‡ä¾è³´å®‰è£
      # ===============================================
      
      - name: ğŸ’¾ Set up ccache (Compilation Cache)
        # æ›´å¥½çš„ ccache æ•´åˆ
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ inputs.target_select }}-${{ inputs.toolchain_select }}

      - name: 'âš™ï¸ Set up Go and Node Environments'
        run: echo "Setting up Go 1.20 and Node 18.x"
        
      - uses: actions/setup-go@v4
        with:
          go-version: '1.20'
          check-latest: true
          cache: false
          
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          check-latest: true
          
      - name: 'ğŸš€ Install Complete Build Dependencies'
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "--- æ›´æ–°å¥—ä»¶æ¸…å–®ä¸¦å®‰è£æ‰€æœ‰ç·¨è­¯ä¾è³´ ---"
          sudo apt update
          sudo apt install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git ccache \
            build-essential fakeroot flex bison gawk gperf \
            autotools-dev autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config jq rsync
          
          # è¨­å®šå»ºç½®æ—¥æœŸè®Šæ•¸
          echo "BUILD_DATE=$(TZ='Asia/Taipei' date +%Y%m%d)" >> $GITHUB_ENV

      # ===============================================
      # æ­¥é©Ÿ 1: å¤–éƒ¨å·¥å…·éˆä¸‹è¼‰èˆ‡å®‰è£ (External Toolchain Only)
      # ===============================================
      - name: 'â¬‡ï¸ Download and Install External Toolchain'
        env:
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
          # çµ±ä¸€ç›®æ¨™ç›®éŒ„çµæ§‹ï¼Œç¢ºä¿èˆ‡é æœŸä¸€è‡´
          TOOLCHAIN_DIR: trunk/toolchain-mipsel/toolchain-4.4.x
        run: |
          echo ">>> Using external URL download logic for $TOOLCHAIN_TAG."
          mkdir -p trunk/toolchain-mipsel

          case "$TOOLCHAIN_TAG" in
            "hanwckf-default")
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/linux-4.4-v1.0/mipsel-linux-uclibc.tar.xz"
              ;;
            "turbotse-musl")
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
              ;;
            "turbotse-uclibc")
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz"
              ;;
            "tsl0922-musl")
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
              ;;
            "tsl0922-uclibc")
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz"
              ;;
            "hanwckf-uclibc-v1.1")
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz"
              ;;
            *)
              echo "Error: Unknown toolchain tag: $TOOLCHAIN_TAG."
              exit 1
              ;;
          esac
          
          FILENAME=$(basename "$URL")
          curl -o "$FILENAME" -L "$URL"
          TEMP_DIR=$(mktemp -d)
          
          # ä½¿ç”¨ sudo é€²è¡Œè§£å£“ï¼Œç¢ºä¿æ¬Šé™
          sudo tar -xf "$FILENAME" -C "$TEMP_DIR"
          
          # æŸ¥æ‰¾çœŸæ­£çš„å·¥å…·éˆæ ¹ç›®éŒ„ (è™•ç†å£“ç¸®åŒ…å…§é¡å¤–ç›®éŒ„çµæ§‹)
          TOOLCHAIN_ROOT="$TEMP_DIR"
          VALID_SUBDIRS=($(find "$TEMP_DIR" -maxdepth 1 -type d ! -name "$(basename "$TEMP_DIR")" -print))
          if [ ${#VALID_SUBDIRS[@]} -eq 1 ]; then
              if [ -d "${VALID_SUBDIRS[0]}/bin" ]; then
                  TOOLCHAIN_ROOT="${VALID_SUBDIRS[0]}"
              fi
          fi

          # è¦†è“‹æˆ–å»ºç«‹ç›®æ¨™ç›®éŒ„
          sudo rm -rf "$TOOLCHAIN_DIR"
          sudo mkdir -p "$TOOLCHAIN_DIR"
          # ä½¿ç”¨ sudo é€²è¡Œè¤‡è£½
          sudo cp -r "$TOOLCHAIN_ROOT"/* "$TOOLCHAIN_DIR"/
          sudo chmod -R 755 "$TOOLCHAIN_DIR/bin" 2>/dev/null || true
          
          # æª¢æŸ¥ä¸¦ç§»é™¤å…§å»º toolchain çš„ Makefileï¼Œé˜²æ­¢ç·¨è­¯æ™‚å†æ¬¡ä¸‹è¼‰/è¡çª
          if [ -f "trunk/toolchain/Makefile" ]; then
              sudo mv trunk/toolchain/Makefile trunk/toolchain/Makefile.bak
              echo ">>> ğŸš¨ WARNING: Renamed trunk/toolchain/Makefile to prevent internal download conflict."
          fi
          
          echo "âœ… External toolchain $TOOLCHAIN_TAG installed successfully to $TOOLCHAIN_DIR."
          sudo rm -rf "$TEMP_DIR"
          
      - name: 'ğŸ”— Create Global Bin Links'
        env:
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
        run: |
          TOOLCHAIN_SRC=$(pwd)/trunk/toolchain-mipsel/toolchain-4.4.x
          
          if [ ! -d "$TOOLCHAIN_SRC/bin" ]; then
              echo "::error:: âŒ Toolchain bin directory is missing after installation."
              exit 1
          fi

          # 1. å»ºç«‹ /toolchain-4.4.x è»Ÿé€£çµ (å…¼å®¹èˆŠç‰ˆæœ¬ Makefiles)
          sudo rm -rf /toolchain-4.4.x
          sudo ln -s $TOOLCHAIN_SRC /toolchain-4.4.x
          
          # 2. æŸ¥æ‰¾å‰ç¶´ä¸¦å»ºç«‹ /bin/ è»Ÿé€£çµ
          # ç›®æ¨™æ˜¯ç¢ºä¿ /bin/ ä¸‹æœ‰ {TOOLCHAIN_TAG}-gcc å’Œæ¨™æº–çš„ mipsel-linux-*-gcc
          
          # å°‹æ‰¾åŸå§‹å‰ç¶´ (e.g., mipsel-linux-musl-)
          LINK_FROM=""
          if ls "$TOOLCHAIN_SRC/bin/mipsel-linux-musl-"* 1> /dev/null 2>&1; then
              LINK_FROM="mipsel-linux-musl-"
          elif ls "$TOOLCHAIN_SRC/bin/mipsel-linux-uclibc-"* 1> /dev/null 2>&1; then
              LINK_FROM="mipsel-linux-uclibc-"
          else
              # å‚™ç”¨æŸ¥æ‰¾é‚è¼¯
              LINK_FROM=$(ls "$TOOLCHAIN_SRC/bin/"*-gcc | head -n 1 | xargs basename | sed 's/-gcc//')
              LINK_FROM="${LINK_FROM}-"
          fi
          
          EXPECTED_PREFIX="$TOOLCHAIN_TAG-"

          find "$TOOLCHAIN_SRC/bin" -maxdepth 1 -type f -name "$LINK_FROM*" | while read -r target_path_original; do
              FILENAME=$(basename "$target_path_original")
              TOOLNAME=${FILENAME#$LINK_FROM}
              
              # å»ºç«‹æ¨™æº–åç¨±è»Ÿé€£çµ (e.g., mipsel-linux-musl-gcc -> /bin/mipsel-linux-musl-gcc)
              TARGET_FOR_ALIAS="/bin/$FILENAME"
              sudo ln -sf "$target_path_original" "$TARGET_FOR_ALIAS"
              
              # å»ºç«‹è‡ªå®šç¾©åç¨±è»Ÿé€£çµ (e.g., tsl0922-musl-gcc -> /bin/tsl0922-musl-gcc)
              EXPECTED_NAME="$EXPECTED_PREFIX$TOOLNAME"
              EXPECTED_PATH="/bin/$EXPECTED_NAME"
              if [ ! -f "$EXPECTED_PATH" ]; then
                  sudo ln -sf "$TARGET_FOR_ALIAS" "$EXPECTED_PATH"
              fi
          done
          
          echo "âœ… Toolchain linked to /bin and /toolchain-4.4.x."
          # å°‡ /bin æ–°å¢åˆ° PATH è®Šæ•¸ï¼Œä»¥ä¾¿ Make èƒ½å¤ æ‰¾åˆ°äº¤å‰ç·¨è­¯å™¨
          echo "/bin" >> $GITHUB_PATH


      # ===============================================
      # æ­¥é©Ÿ 2: å®¢è£½åŒ–é…ç½®
      # ===============================================
      
      - name: 'âš™ï¸ Export Customization Variables'
        run: |
          export_json() {
            local JSON=$1
            # ä½¿ç”¨ jq å°‡ JSON è½‰æ›ç‚º KEY=VALUE æ ¼å¼ï¼Œä¸¦å°å‡ºç‚º GITHUB_ENV
            echo "$JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
              echo "${k^^}=$v" >> $GITHUB_ENV
            done
          }
          export_json '${{ inputs.customization }}'

      - name: 'ğŸ“ Execute Customization Scripts'
        run: |
          if [ -d "trunk/custom/scripts" ]; then
              chmod +x trunk/custom/scripts/*.sh
              
              bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/src/defaults.h trunk/user/www/dict/CN.dict || true
              bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/src/defaults.h || true
              bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/src/defaults.h || true
              
              echo "âœ… Custom settings applied to source code."
          else
              echo "âš ï¸ Custom scripts folder not found. Skipping customization."
          fi
          
      # ===============================================
      # æ­¥é©Ÿ 3: Host Tools ç·¨è­¯ (Bug Fix)
      # ===============================================
      - name: 'ğŸ”¨ Pre-Build Host Tools (Fix mkimage bug)'
        run: |
          echo ">>> ğŸ—ï¸ Stage 1: Building Host Tools with CLEAN Environment..."
          cd trunk
          
          # ğŸš¨ é—œéµä¿®æ­£: ä¿®å¾© mkimage.c çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²éŒ¯èª¤
          if [ -f "tools/mkimage/mkimage.c" ]; then
              echo ">>> ğŸ”§ Patching tools/mkimage/mkimage.c to fix sscanf buffer overflow..."
              sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' tools/mkimage/mkimage.c
              sed -i 's/"%d\.%d%c"/"%hhd.%hhd%c"/g' tools/mkimage/mkimage.c
              echo "âœ… mkimage.c patched."
          fi

          # å¼·åˆ¶æ¸…ç†ä¸¦ç·¨è­¯ tools
          make -C tools clean || true
          make -C tools
          
          echo "âœ… Stage 1: Host tools built successfully."
          cd ..
      
      # ===============================================
      # æ­¥é©Ÿ 4: å›ºä»¶é…ç½®èˆ‡ç’°å¢ƒè®Šæ•¸è¨­å®š
      # ===============================================
      - name: 'ğŸ—ï¸ Configure and Set Environment'
        env:
          TNAME: ${{ inputs.target_select }}
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
        run: |
          # 1. é€²å…¥ TRUNK ç›®éŒ„é€²è¡Œé…ç½®
          cd trunk
          
          # 2. è¤‡è£½é…ç½®èˆ‡ Nano é‚è¼¯
          cp -f configs/templates/$TNAME.config .config
          
          if [ "${{ inputs.nanoversion }}" = "true" ]; then
            echo ">>> ğŸš¨ Applying Nano Optimization for extreme slimming (Configuration only)..."
            # ç¢ºä¿ OPENSSL_EXE é è¨­é–‹å•Ÿï¼Œå› ç‚º Nano å„ªåŒ–å¯èƒ½æœƒé—œé–‰ OpenSSL
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/g' .config
            
            # ç§»é™¤æ–‡ä»¶ç³»çµ±æ”¯æŒ
            for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" .config
            done
            
            # ç§»é™¤å¤§é‡æ¨¡çµ„
            modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED
              SMBD WINS SMBD_SYSLOG FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN SSWAN
              XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION TRANSMISSION_WEB_CONTROL ARIA QOS
              ARIA_WEB_CONTROL SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT
              SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE LRZSZ HTOP NANO IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY MENTOHUST
              FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER SMARTDNS
              ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER SQM WIREGUARD)
              
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" .config
            done
            
            # ç¢ºä¿ä¿ç•™æ¨¡çµ„
            keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE)
            for mod in "${keep_modules[@]}"; do
              sed -i "/CONFIG_FIRMWARE_INCLUDE_${mod}/d" .config
              echo "CONFIG_FIRMWARE_INCLUDE_${mod}=y" >> .config
            done
            
            echo "âœ… Nano Optimization applied."
          fi
          
          # 3. BusyBox Makefile ä¿®è£œ
          BUSYBOX_MAKEFILE="user/busybox/Makefile"
          if [ -f "$BUSYBOX_MAKEFILE" ]; then
            echo ">>> ğŸ”§ Patching $BUSYBOX_MAKEFILE (Removing EXTRA_LIBS)..."
            cp "$BUSYBOX_MAKEFILE" "$BUSYBOX_MAKEFILE.bak"
            sed -i '/EXTRA_LIBS =/c\EXTRA_LIBS =' "$BUSYBOX_MAKEFILE"
            echo "âœ… BusyBox Makefile patched."
          fi
          
          # 4. å›åˆ°é ‚å±¤ç›®éŒ„æº–å‚™ç·¨è­¯
          cd ..
          
          # 5. è™•ç†é ‚å±¤ Makefile (åˆªé™¤ toolchain é‚è¼¯)
          echo ">>> ğŸ”§ PATCHING: Temporarily removing toolchain build/download logic from main Makefile..."
          cp Makefile Makefile.bak
          sed -i '/toolchain/d' Makefile
          echo "âœ… Makefile patched successfully."
          
          # 6. è¨­ç½®äº¤å‰ç·¨è­¯ç’°å¢ƒè®Šæ•¸ (ä½¿ç”¨è»Ÿé€£çµåç¨±)
          echo ">>> ğŸ› ï¸ Setting Toolchain environment variables for FIRMWARE build."
          
          # äº¤å‰ç·¨è­¯å·¥å…·çš„è·¯å¾‘ï¼ŒæŒ‡å‘ /bin/ ä¸‹çš„è»Ÿé€£çµ
          GCC_PATH="/bin/${TOOLCHAIN_TAG}-gcc"
          TOOLCHAIN_ROOT=$(pwd)/trunk/toolchain-mipsel/toolchain-4.4.x
          
          # ------------------------------------------------------------------------
          # Sysroot æŸ¥æ‰¾é‚è¼¯ï¼šæŒ‰å„ªå…ˆç´šä¾åºå˜—è©¦ (æ ¹æ“šå·¥å…·éˆæª”æ¡ˆåˆ†æçµæœä¿®æ­£)
          # ------------------------------------------------------------------------
          SYSROOT_DIR="" # åˆå§‹åŒ– Sysroot è·¯å¾‘
          
          # å˜—è©¦æ–¹æ³• A (æœ€ç²¾ç¢º): GCC å…§éƒ¨å‘½ä»¤
          echo ">>> 1/3: Trying GCC --print-sysroot..."
          SYSROOT_DIR=$($GCC_PATH --print-sysroot 2>/dev/null)
          
          # å˜—è©¦æ–¹æ³• B (æœ€å¯é çš„é€šç”¨ Padavan è·¯å¾‘ - æ ¹æ“šæª”æ¡ˆçµæ§‹åˆ†æ)
          if [ -z "$SYSROOT_DIR" ] || [ ! -d "$SYSROOT_DIR" ]; then
            EXPLICIT_SYSROOT_DIR="$TOOLCHAIN_ROOT/sysroot"
            echo ">>> 2/3: Trying explicit Sysroot path: $EXPLICIT_SYSROOT_DIR"
            
            if [ -d "$EXPLICIT_SYSROOT_DIR" ]; then
                SYSROOT_DIR="$EXPLICIT_SYSROOT_DIR"
                echo ">>> âœ… Found Sysroot at explicit path."
            else
                # å˜—è©¦æ–¹æ³• C (å‚™ç”¨): æ“´å¤§ find æ·±åº¦ï¼Œä»¥é˜²çµæ§‹åµŒå¥—
                echo ">>> 3/3: Trying generic find (maxdepth 5)..."
                SYSROOT_DIR=$(find "$TOOLCHAIN_ROOT" -maxdepth 5 -type d -name "sysroot" | head -n 1)
            fi
          fi
          # ------------------------------------------------------------------------
          
          # æœ€çµ‚æª¢æŸ¥
          if [ -z "$SYSROOT_DIR" ] || [ ! -d "$SYSROOT_DIR" ]; then
              echo "::error:: âŒ Critical Failure: Could not locate Sysroot directory."
              echo "  - Checked paths: \$GCC_PATH --print-sysroot, \$TOOLCHAIN_ROOT/sysroot, and deep find."
              exit 1
          fi
          
          # å°å‡º CROSS_COMPILE ç›¸é—œè®Šæ•¸
          echo "LDFLAGS=-Wl,--sysroot=$SYSROOT_DIR" >> $GITHUB_ENV
          echo "CC=$GCC_PATH" >> $GITHUB_ENV
          echo "CXX=${GCC_PATH}pp" >> $GITHUB_ENV
          # ç¢ºä¿ BUSYBOX_CC è®Šæ•¸æŒ‡å‘æ­£ç¢ºçš„ç·¨è­¯å™¨
          echo "BUSYBOX_CC=$GCC_PATH" >> $GITHUB_ENV
          
          # LD å’Œ AS ç”±æ–¼å·²é€£çµåˆ° /binï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å¸¶å‰ç¶´çš„åç¨±
          echo "LD=${TOOLCHAIN_TAG}-ld" >> $GITHUB_ENV
          echo "AS=${TOOLCHAIN_TAG}-as" >> $GITHUB_ENV
          echo "CROSS_COMPILE=${TOOLCHAIN_TAG}-" >> $GITHUB_ENV
          
          # Go èªè¨€ç·¨è­¯ç’°å¢ƒè®Šæ•¸
          echo "GOOS=linux" >> $GITHUB_ENV
          echo "GOARCH=mipsle" >> $GITHUB_ENV
          echo "CGO_ENABLED=1" >> $GITHUB_ENV
          
          echo "âœ… Environment ready. Sysroot: $SYSROOT_DIR"
          echo "âœ… CC: $GCC_PATH"

      # ===============================================
      # æ­¥é©Ÿ 5: å›ºä»¶ç·¨è­¯èˆ‡æ¸…ç†
      # ===============================================
      - name: 'ğŸš€ Execute Firmware Build'
        env:
          TNAME: ${{ inputs.target_select }}
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
          # é‡æ–°å°å‡º make æ‰€éœ€çš„è®Šæ•¸ï¼Œç¢ºä¿å®ƒå€‘åœ¨å­ shell ä¸­å¯ç”¨
          LDFLAGS: ${{ env.LDFLAGS }}
          CC: ${{ env.CC }}
          CXX: ${{ env.CXX }}
          LD: ${{ env.LD }}
          AS: ${{ env.AS }}
          CROSS_COMPILE: ${{ env.CROSS_COMPILE }}
          BUSYBOX_CC: ${{ env.BUSYBOX_CC }}
          GOOS: ${{ env.GOOS }}
          GOARCH: ${{ env.GOARCH }}
          CGO_ENABLED: ${{ env.CGO_ENABLED }}
        run: |
          echo ">>> ğŸš€ Starting Final Build in $(pwd): sudo make $TNAME TOOLCHAIN=$TOOLCHAIN_TAG"
          # åœ¨é ‚å±¤ç›®éŒ„åŸ·è¡Œ make K2Pï¼ŒåŒæ™‚å‚³éè‡ªå®šç¾© Toolchain æ¨™ç±¤
          # ä½¿ç”¨ sudo ç¢ºä¿æ‰€æœ‰ Make çš„è¡Œç‚ºï¼ˆåŒ…æ‹¬å‰µå»ºç›®éŒ„ã€å¯«å…¥æª”æ¡ˆï¼‰éƒ½æœ‰æ¬Šé™
          sudo make $TNAME TOOLCHAIN=$TOOLCHAIN_TAG

          # æ¢å¾©é ‚å±¤ Makefile
          if [ -f Makefile.bak ]; then
              echo ">>> Restoring original Makefile..."
              mv Makefile.bak Makefile
          fi

          # æ¢å¾© BusyBox Makefile
          BUSYBOX_MAKEFILE="trunk/user/busybox/Makefile"
          if [ -f "$BUSYBOX_MAKEFILE.bak" ]; then
              echo ">>> Restoring BusyBox Makefile..."
              mv "$BUSYBOX_MAKEFILE.bak" "$BUSYBOX_MAKEFILE"
          fi
          
          # ç¢ºä¿ images ç›®éŒ„å­˜åœ¨ (åœ¨ Padavan çš„ Make æµç¨‹ä¸­å¯èƒ½å·²ç¶“å‰µå»º)
          mkdir -p trunk/images
          
          # æª¢æŸ¥ä¸¦é‡å‘½åå›ºä»¶
          OUTPUT_NAME="$TNAME"
          [ "${{ inputs.nanoversion }}" = "true" ] && OUTPUT_NAME="${OUTPUT_NAME}-nano"
          DATE=${{ env.BUILD_DATE }}
          
          # ä½¿ç”¨ sudo è™•ç†æ–‡ä»¶ç§»å‹•
          image=$(ls trunk/images/*.trx 2>/dev/null | head -n 1)
          if [ ! -z "$image" ]; then
              sudo mv "$image" "trunk/images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx"
              echo "âœ… Build success. Final image: trunk/images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx"
          else
              echo "::error:: âŒ Compilation succeeded but no .trx image was found in trunk/images/."
              exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.target_select }}-${{ inputs.toolchain_select }}-${{ env.BUILD_DATE }}
          path: trunk/images/*.trx

      # ===============================================
      # æ­¥é©Ÿ 6: ç™¼ä½ˆ (Release)
      # ===============================================
      publish:
        needs: [build]
        # çµ±ä¸€ä½¿ç”¨ Ubuntu 22.04 LTS
        runs-on: ubuntu-22.04
        permissions:
          contents: write
        
        # åƒ…åœ¨ main åˆ†æ”¯ä¸ŠåŸ·è¡Œç™¼ä½ˆ
        if: ${{ github.ref == 'refs/heads/main' }}
        steps:
          - uses: actions/checkout@v3
          
          - uses: actions/download-artifact@v4
            with:
              path: artifacts
              
          - name: 'Organize Artifacts'
            run: |
              mkdir -p release_files
              find artifacts -name "*.trx" -exec cp {} release_files/ \;
              ls -l release_files/
              
          - name: 'Set Tag Name'
            # ä½¿ç”¨ BUILD_DATE å’Œ Run Number ç¢ºä¿æ¨™ç±¤å”¯ä¸€æ€§
            run: echo "TAG_ANME=${{ env.BUILD_DATE }}-${{ github.run_number }}" >> $GITHUB_ENV
            
          - uses: rickstaa/action-create-tag@v1
            with:
              tag: ${{ env.TAG_ANME }}
              # è¨­ç½® force_push_tag: true å…è¨±è¦†è“‹åŒå tagï¼Œé¿å…è¡çª
              force_push_tag: true
              
          - uses: ncipollo/release-action@v1
            with:
              commit: ${{ github.sha }}
              tag: ${{ env.TAG_ANME }}
              artifacts: "release_files/*.trx"
              allowUpdates: true
