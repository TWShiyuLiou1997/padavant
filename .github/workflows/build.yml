name: Custom Padavan Build (K2P/K2P-NANO/K2P-USB)

on:
  # å…è¨±æ‰‹å‹•è§¸ç™¼ï¼Œä¸¦å¯å‚³å…¥æ‰€æœ‰å®¢è£½åŒ–åƒæ•¸
  workflow_dispatch:
    inputs:
      target_select:
        description: "Select Target Model"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
        default: K2P
        
      nanoversion:
        description: "Apply Nano Optimization (Extreme slimming config)"
        type: boolean
        default: false
        
      toolchain_select:
        description: "Select Compilation Toolchain"
        required: true
        type: choice
        options:
          # åŸå§‹è…³æœ¬çš„ Toolchain
          - mipsel-linux-musl (v1.0, musl) # åŸå§‹è…³æœ¬çš„ Toolchain
          # æ–°å¢çš„ 6 å€‹ Toolchain
          - hanwckf/default (linux-4.4-v1.0, uclibc)
          - TurboTse/musl (gcc 13.3.0, musl 1.2.5)
          - TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)
          - tsl0922/musl (gcc 13.2.0, musl 1.2.4)
          - tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)
          - hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32)
        default: hanwckf/default (linux-4.4-v1.0, uclibc) # å°‡å…¶ä¸­ä¸€å€‹æ–°é¸é …è¨­ç‚ºé è¨­
        
      customization:
        description: 'Customization JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

jobs:
  build:
    runs-on: ubuntu-22.04 # ä¿æŒä½¿ç”¨ ubuntu-22.04
    # é€™è£¡ä¸å†ä½¿ç”¨ matrixï¼Œè€Œæ˜¯ä½¿ç”¨ inputs
    steps:
      - name: ğŸ“¥ Checkout Repository (å·¥ä½œç©ºé–“æº–å‚™)
        uses: actions/checkout@v3
        
      # ===============================================
      # ğŸš€ æ­¥é©Ÿ 0.1: å®‰è£ä¾è³´ (ä½¿ç”¨å®Œæ•´çš„ä¾è³´åˆ—è¡¨)
      # ===============================================
      - name: ğŸš€ Install Complete Build Dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "--- æ›´æ–°å¥—ä»¶æ¸…å–®ä¸¦å®‰è£æ‰€æœ‰ç·¨è­¯ä¾è³´ ---"
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git \
            build-essential fakeroot flex bison gawk gperf \
            autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq

          # è¨­å®šå»ºç½®æ—¥æœŸè®Šæ•¸
          echo "BUILD_DATE=$(TZ='Asia/Taipei' date +%Y%m%d)" >> $GITHUB_ENV
          mkdir -p /opt/images/
          
      # ===============================================
      # ğŸ’¾ æ­¥é©Ÿ 0.2: è¨­å®š ccache
      # ===============================================
      - name: ğŸ’¾ Set up ccache (Compilation Cache)
        uses: hendrikmuhs/ccache-action@v1.2
        env:
          # è½‰æ›å«æœ‰é€—è™Ÿçš„é¸é …åç¨±ç‚ºç°¡æ½”çš„å¿«å–æ¨™ç±¤
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select == 'mipsel-linux-musl (v1.0, musl)' && 'original-musl' || inputs.toolchain_select == 'hanwckf/default (linux-4.4-v1.0, uclibc)' && 'hanwckf-default' || inputs.toolchain_select == 'TurboTse/musl (gcc 13.3.0, musl 1.2.5)' && 'TurboTse-musl' || inputs.toolchain_select == 'TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)' && 'TurboTse-uclibc' || inputs.toolchain_select == 'tsl0922/musl (gcc 13.2.0, musl 1.2.4)' && 'tsl0922-musl' || inputs.toolchain_select == 'tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)' && 'tsl0922-uclibc' || inputs.toolchain_select == 'hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32)' && 'hanwckf-uclibc-v1.1' || 'other' }}
        with:
          key: ${{ runner.os }}-ccache-${{ env.TOOLCHAIN_TAG }}-${{ inputs.target_select }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ env.TOOLCHAIN_TAG }}-
            
      # ===============================================
      # âš™ï¸ æ­¥é©Ÿ 0.3: è¨­å®š Go èªè¨€ç’°å¢ƒ (ä½¿ç”¨æ‚¨ç¬¬ä¸€å€‹è…³æœ¬çš„ç‰ˆæœ¬)
      # ===============================================
      - name: âš™ï¸ Set up Go Environment
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'
          check-latest: true
          cache: false
          
      # âš™ï¸ æ­¥é©Ÿ 0.4: è¨­å®š Node ç’°å¢ƒ (ä¿ç•™ç¬¬ä¸€å€‹è…³æœ¬çš„ Node 18)
      - name: âš™ï¸ Set up Node Environment
        uses: actions/setup-node@v3
        with:
          node-version: 18
          check-latest: true

      # ===============================================
      # æ­¥é©Ÿ 1: JSON é©—è­‰èˆ‡è®Šæ•¸å°å‡º
      # ===============================================
      - name: âš™ï¸ Export Customization Flags
        run: |
          jq empty <<< '${{ inputs.customization }}' || { echo "âŒ Invalid customization JSON"; exit 1; }

          export_json() {
            local JSON=$1
            echo "$JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
              echo "${k^^}=$v" >> $GITHUB_ENV # è½‰æ›ç‚ºå¤§å¯« (LANIP, SIGNACCOUNT, etc.)
            done
          }
          export_json '${{ inputs.customization }}'
          echo "âœ… Customization variables exported to environment."

      # ===============================================
      # æ­¥é©Ÿ 2: Toolchain ä¸‹è¼‰èˆ‡è™•ç†
      # ===============================================
      # ç”±æ–¼æ²’æœ‰å…‹éš† Padavan Source Codeï¼Œé€™è£¡å‡è¨­ Toolchain è…³æœ¬/çµæ§‹åœ¨ç•¶å‰ Repo çš„ /toolchain-mipsel
      # å¦‚æœ Padavan æºç¢¼åœ¨å¦ä¸€å€‹ Repoï¼Œæ‚¨éœ€è¦åœ¨æ­¥é©Ÿ 0.1 ä¹‹å¾ŒåŠ å…¥å…‹éš†æ­¥é©Ÿ
      # é€™è£¡æˆ‘å€‘ä½¿ç”¨ä¸€å€‹è‡¨æ™‚ç›®éŒ„ä¾†è™•ç† Toolchain ä¸‹è¼‰
      - name: â¬‡ï¸ Prepare and Download Selected Toolchain
        env:
          TOOLCHAIN_CHOICE: ${{ inputs.toolchain_select }}
          # å‡è¨­æ‚¨å°‡å·¥å…·éˆæ”¾åœ¨ /opt/toolchain/mipsel-toolchain
          TOOLCHAIN_DIR: /opt/toolchain/mipsel-toolchain
        run: |
          mkdir -p /opt/toolchain
          
          # 1. æ±ºå®šä¸‹è¼‰ URL
          case "$TOOLCHAIN_CHOICE" in
            "mipsel-linux-musl (v1.0, musl)")
              # åŸå§‹è…³æœ¬çš„ Toolchainï¼Œå‡è¨­å…¶ URL ç‚ºï¼š
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.0/mipsel-linux-musl.tar.xz"
              ;;
            "hanwckf/default (linux-4.4-v1.0, uclibc)")
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.0/mipsel-linux-uclibc.tar.xz"
              ;;
            "TurboTse/musl (gcc 13.3.0, musl 1.2.5)")
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
              ;;
            "TurboTse/uclibc (gcc 13.3.0, uClibc-ng 1.0.52)")
              URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz"
              ;;
            "tsl0922/musl (gcc 13.2.0, musl 1.2.4)")
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz"
              ;;
            "tsl0922/uclibc (gcc 13.2.0, uClibc-ng 1.0.43)")
              URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz"
              ;;
            "hanwckf/uclibc-v1.1 (gcc 7.4.0, uclibc 1.0.32)")
              URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz"
              ;;
            *)
              echo "Error: Unknown toolchain choice."
              exit 1
              ;;
          esac
          
          # 2. ä¸‹è¼‰ã€æ¸…ç†èˆŠç›®éŒ„ä¸¦è§£å£“
          FILENAME=$(basename "$URL")
          echo "Downloading $FILENAME from $URL"
          curl -O -L "$URL"
          
          sudo rm -rf "$TOOLCHAIN_DIR"
          sudo mkdir -p "$TOOLCHAIN_DIR"
          
          # æå–åˆ°æŒ‡å®šçš„ Toolchain ç›®éŒ„
          sudo tar -xf "$FILENAME" -C "$TOOLCHAIN_DIR" --strip-components=1
          
          echo "Toolchain $TOOLCHAIN_CHOICE installed successfully to $TOOLCHAIN_DIR."

      # ğŸ”´ æ ¸å¿ƒä¿®æ­£æ­¥é©Ÿï¼šå»ºç«‹è»Ÿé€£çµä»¥ä¿®å¾©å·¥å…·éˆè·¯å¾‘
      # é€™æ˜¯ Padavan ç·¨è­¯æˆåŠŸçš„æœ€é—œéµæ­¥é©Ÿ
      - name: ğŸ”— Fix Toolchain Path Link
        run: |
          # ç¢ºä¿ç›®æ¨™ç›®éŒ„ä¸å­˜åœ¨ (é¿å…é€£çµå¾ªç’°æˆ–è¡çª)
          sudo rm -rf /toolchain-4.4.x
          
          # å»ºç«‹æ­£ç¢ºçš„è»Ÿé€£çµï¼Œè®“ç·¨è­¯å™¨èƒ½æ‰¾åˆ°æ­£ç¢ºè·¯å¾‘
          sudo ln -s /opt/toolchain/mipsel-toolchain /toolchain-4.4.x
          
          # é©—è­‰é€£çµæ˜¯å¦æˆåŠŸ
          if [ -d "/toolchain-4.4.x/bin" ]; then
              echo "âœ… Toolchain path successfully linked: /toolchain-4.4.x -> /opt/toolchain/mipsel-toolchain"
          else
              echo "::error:: âŒ Toolchain link failed or toolchain not properly extracted. Check step 2."
              exit 1
          fi

      # ===============================================
      # æ­¥é©Ÿ 3: æ‡‰ç”¨å®¢è£½åŒ– (å‡è¨­æºç¢¼åœ¨ trunk/)
      # ===============================================
      - name: ğŸ“ Apply Customization to Source Files
        run: |
          # æª¢æŸ¥ custom/scripts å­˜åœ¨æ€§
          if [ ! -d "trunk/custom/scripts" ]; then
             echo "::warning:: æ‰¾ä¸åˆ° trunk/custom/scriptsï¼Œè·³é IP/å¯†ç¢¼å®¢è£½åŒ–ã€‚"
             exit 0
          fi
          
          chmod +x trunk/custom/scripts/*.sh
          
          # 1. ä¿®æ”¹ LAN IP å’Œ WebUI ç¿»è­¯
          bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/src/defaults.h trunk/user/www/dict/CN.dict || true
          # 2. ä¿®æ”¹ SSH/WebUI ç™»å…¥å¸³è™Ÿå’Œå¯†ç¢¼
          bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/src/defaults.h || true
          # 3. ä¿®æ”¹ Wi-Fi SSID å’Œå¯†ç¢¼
          bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/src/defaults.h || true
          
          echo "âœ… Customizations applied."
          
      # ===============================================
      # æ­¥é©Ÿ 4: ç·¨è­¯ (åŒ…å« Nano Logic)
      # ===============================================
      - name: ğŸ—ï¸ Build Firmware (${{ inputs.target_select }} + Nano Logic Applied)
        env:
          TNAME: ${{ inputs.target_select }}
        run: |
          # é€²å…¥ç·¨è­¯æ ¹ç›®éŒ„
          if [ -d "trunk" ]; then
            cd trunk
            echo "âœ… å·²åˆ‡æ›å·¥ä½œç›®éŒ„è‡³: $(pwd)"
          else
            echo "::error:: âŒ åš´é‡éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° trunk ç›®éŒ„ï¼Œè«‹æª¢æŸ¥å…‹éš†æ­¥é©Ÿã€‚"
            exit 1
          fi
          
          NANO_OPT="${{ github.event.inputs.nanoversion }}"
          
          # æª¢æŸ¥å’Œè¤‡è£½é…ç½®æª”æ¡ˆ
          CONFIG_FILE="configs/templates/$TNAME.config"
          if [ ! -f "$CONFIG_FILE" ] ; then
            echo "::error:: æ‰¾ä¸åˆ°è¨­å®šæª”ï¼š$CONFIG_FILEã€‚è«‹æª¢æŸ¥æºç¢¼å€‰åº«ä¸­çš„æª”æ¡ˆæ˜¯å¦å­˜åœ¨ã€‚"
            exit 1
          fi
          
          cp -f "$CONFIG_FILE" .config
          echo "Copied base config for $TNAME."
          
          # ã€Nano å„ªåŒ–é‚è¼¯ã€‘
          if [ "$NANO_OPT" = "true" ]; then
            echo ">>> ğŸš¨ Applying Nano Optimization for extreme slimming..."
            
            # ç¢ºä¿åŸºæœ¬åŠŸèƒ½ OPENSSL_EXE é–‹å•Ÿ
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/g' .config

            # ç§»é™¤æ–‡ä»¶ç³»çµ±æ”¯æŒã€æ¨¡çµ„ç­‰ (ä½¿ç”¨ç¬¬äºŒå€‹è…³æœ¬çš„å„ªåŒ–åˆ—è¡¨)
            # 1. ç§»é™¤æ–‡ä»¶ç³»çµ±æ”¯æŒ
            for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" .config
            done
            
            # 2. ç§»é™¤å¤§é‡æ¨¡çµ„
            modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED
              SMBD WINS SMBD_SYSLOG FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN SSWAN
              XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION TRANSMISSION_WEB_CONTROL ARIA QOS
              ARIA_WEB_CONTROL SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT
              SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE LRZSZ HTOP NANO IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY MENTOHUST
              FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER SMARTDNS
              ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER SQM WIREGUARD)
            
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" .config
            done
            
            # 3. ç¢ºä¿ä¿ç•™æ¨¡çµ„
            keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE)
            for mod in "${keep_modules[@]}"; do
              sed -i "/CONFIG_FIRMWARE_INCLUDE_${mod}/d" .config 
              echo "CONFIG_FIRMWARE_INCLUDE_${mod}=y" >> .config
            done

            echo "âœ… Nano Optimization applied to .config for $TNAME."
          fi
          
          # åŸ·è¡Œç·¨è­¯
          sudo ./clear_tree
          # å‡è¨­ build_firmware_modify è…³æœ¬æ¥å— TNAME ä½œç‚ºåƒæ•¸
          sudo ./build_firmware_modify $TNAME 0
          
          # è™•ç†è¼¸å‡ºæª”æ¡ˆåç¨±
          OUTPUT_NAME="$TNAME"
          [ "$NANO_OPT" = "true" ] && OUTPUT_NAME="${OUTPUT_NAME}-nano"
          
          # ç§»å‹•è¼¸å‡ºæª”æ¡ˆåˆ°ç›®æ¨™ç›®éŒ„ /opt/images
          IMAGE_PATH="../../../opt/images/${OUTPUT_NAME}-${BUILD_DATE}.trx"
          sudo mv -f images/*.trx "$IMAGE_PATH"
          echo "âœ… Build success for $TNAME. Saved as $IMAGE_PATH"

      # æ­¥é©Ÿ 5: ä¸Šå‚³ Artifacts
      - name : ğŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          # ä½¿ç”¨ä¸€å€‹ç°¡å–®çš„åç¨±ï¼ŒåŒ…å«æ—¥æœŸ
          name: ${{ inputs.target_select }}-${{ env.BUILD_DATE }}
          path: /opt/images

  # ===============================================
  # ç™¼å¸ƒ Job (åƒ…åœ¨ main åˆ†æ”¯è§¸ç™¼æ™‚é‹è¡Œ)
  # ===============================================
  publish:
    needs: [build]
    runs-on: ubuntu-22.04
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v3
      
      # ğŸš¨ ä¿®æ­£ï¼šä¸‹è¼‰æ‰€æœ‰ Artifacts
      - uses: actions/download-artifact@v4
        with:
          name: all-artifacts # ä¸‹è¼‰æ‰€æœ‰ artifact
          path: artifacts

      - name: Organize Artifacts
        run: |
          mkdir -p release_files
          # å°‡æ‰€æœ‰ä¸‹è¼‰çš„ .trx æ–‡ä»¶é›†ä¸­åˆ°ä¸€å€‹ç›®éŒ„
          find artifacts -name "*.trx" -exec cp {} release_files/ \;
          ls -l release_files/

      - name: Set Tag Name
        run: echo "TAG_ANME=$(date +%Y%m%d)" >> $GITHUB_ENV
        
      - uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ env.TAG_ANME }}
          force_push_tag: true
          
      - uses: ncipollo/release-action@v1
        with:
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_ANME }}
          artifacts: "release_files/*.trx"
          allowUpdates: true
