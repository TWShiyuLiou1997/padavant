name: Build Single Target (V8.45 Stable)

on:
  workflow_dispatch:
    inputs:
      target_select:
        description: "Select Target Router Model"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
        default: K2P
        
      toolchain_select:
        description: "Select Compilation Toolchain"
        required: true
        type: choice
        options:
          - mipsel-linux-musl    # æ¨¡å¼ A: åŽŸå§‹ç¢¼å…§å»º (è‡ªå‹•ç·¨è­¯)
          - hanwckf-default      # æ¨¡å¼ B: å¤–éƒ¨ä¸‹è¼‰
          - turbotse-musl
          - turbotse-uclibc
          - tsl0922-musl
          - tsl0922-uclibc
          - hanwckf-uclibc-v1.1
        default: mipsel-linux-musl 
        
      nanoversion:
        description: "Apply Nano Optimization"
        type: boolean
        default: false
        
      customization:
        description: 'Customization JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

jobs:
  build:
    # ðŸŒŸ å›žæ­¸ Ubuntu 22.04ï¼Œé€™èƒ½è§£æ±º Host Tools (mkimage) çš„ç‰ˆæœ¬å…¼å®¹å•é¡Œï¼Œç¬¦åˆæ‚¨çš„æˆåŠŸè…³æœ¬
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      
      # ===============================================
      # 1. ç’°å¢ƒæº–å‚™ (å®Œå…¨æŽ¡ç”¨æˆåŠŸè…³æœ¬çš„ä¾è³´)
      # ===============================================
      - name: 'âš™ï¸ Set up Go and Node' 
        uses: actions/setup-go@v4
        with:
          go-version: '1.20' # éŽ–å®š 1.20 é¿å…æ–°ç‰ˆ Go å°èˆŠç‰ˆæºç¢¼çš„å…¼å®¹å•é¡Œ
          check-latest: true
          cache: false
          
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: 'ðŸš€ Install Dependencies (Fixed List)' 
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git \
            build-essential fakeroot flex bison gawk gperf \
            autotools-dev autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq
          
          # è¨­ç½® Go äº¤å‰ç·¨è­¯è®Šæ•¸ (è§£æ±º Xray ç·¨è­¯éŒ¯èª¤)
          echo "GOOS=linux" >> $GITHUB_ENV
          echo "GOARCH=mipsle" >> $GITHUB_ENV
          echo "GOMIPS=softfloat" >> $GITHUB_ENV
          echo "BUILD_DATE=$(TZ='Asia/Taipei' date +%Y%m%d)" >> $GITHUB_ENV

      - name: 'ðŸ’¾ Configure ccache' 
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ inputs.target_select }}-${{ inputs.toolchain_select }}

      # ===============================================
      # 2. Toolchain è™•ç† (V8.45 æ ¸å¿ƒé‚è¼¯)
      # ===============================================
      - name: 'ðŸ”§ Prepare Toolchain (Adaptive Strategy)'
        env:
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
        run: |
          echo ">>> Processing Toolchain: $TOOLCHAIN_TAG"
          
          # å¦‚æžœé¸æ“‡ mipsel-linux-musl (å…§å»ºæ¨¡å¼)ï¼Œç›´æŽ¥è·³éŽä¸‹è¼‰
          if [ "$TOOLCHAIN_TAG" == "mipsel-linux-musl" ]; then
            echo ">>> [Mode A] Selected Internal Source Toolchain."
            echo ">>> Skipping manual download. 'make' will handle crosstool-ng automatically."
            # ç¢ºä¿ç›®éŒ„ä¹¾æ·¨ï¼Œè§¸ç™¼ Makefile çš„ä¸‹è¼‰é‚è¼¯
            rm -rf trunk/toolchain-mipsel/toolchain-4.4.x
            exit 0
          fi

          # å¦‚æžœé¸æ“‡å…¶ä»– (å¤–éƒ¨æ¨¡å¼)ï¼ŒåŸ·è¡Œä¸‹è¼‰ä¸¦è¨­ç½® PATH
          echo ">>> [Mode B] Selected External Toolchain. Downloading..."
          mkdir -p trunk/toolchain-mipsel
          
          case "$TOOLCHAIN_TAG" in
            "hanwckf-default") URL="https://github.com/hanwckf/padavan-toolchain/releases/download/linux-4.4-v1.0/mipsel-linux-uclibc.tar.xz" ;;
            "turbotse-musl")   URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" ;;
            "turbotse-uclibc") URL="https://github.com/TurBoTse/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" ;;
            "tsl0922-musl")    URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-musl.tar.xz" ;;
            "tsl0922-uclibc")  URL="https://github.com/tsl0922/padavan/releases/download/toolchain/mipsel-linux-uclibc.tar.xz" ;;
            "hanwckf-uclibc-v1.1") URL="https://github.com/hanwckf/padavan-toolchain/releases/download/v1.1/mipsel-linux-uclibc.tar.xz" ;;
            *) echo "Error: Unknown toolchain"; exit 1 ;;
          esac

          echo "Downloading from: $URL"
          curl -fSsLo toolchain.tar.xz "$URL"
          
          # è§£å£“åˆ°è‡¨æ™‚ç›®éŒ„
          TEMP_DIR=$(mktemp -d)
          tar -xf toolchain.tar.xz -C "$TEMP_DIR"
          
          # æ™ºèƒ½å°‹æ‰¾ bin ç›®éŒ„
          TOOLCHAIN_ROOT=""
          if [ -d "$TEMP_DIR/bin" ]; then
             TOOLCHAIN_ROOT="$TEMP_DIR"
          else
             # å°‹æ‰¾ç¬¬ä¸€å±¤å­ç›®éŒ„
             SUBDIR=$(find "$TEMP_DIR" -maxdepth 1 -type d ! -name "$(basename "$TEMP_DIR")" | head -n 1)
             if [ -n "$SUBDIR" ]; then TOOLCHAIN_ROOT="$SUBDIR"; fi
          fi

          if [ -z "$TOOLCHAIN_ROOT" ]; then
             echo "::error:: Failed to locate toolchain root after extraction."
             exit 1
          fi

          TARGET_DIR="$(pwd)/trunk/toolchain-mipsel/toolchain-4.4.x"
          mkdir -p "$(dirname "$TARGET_DIR")"
          rm -rf "$TARGET_DIR"
          mv "$TOOLCHAIN_ROOT" "$TARGET_DIR"
          
          echo ">>> Toolchain installed to: $TARGET_DIR"
          
          # ðŸŒŸ [é—œéµä¿®æ­£]ï¼šå°‡ bin åŠ å…¥ GITHUB_PATHï¼Œè€Œä¸æ˜¯è»Ÿé€£çµåˆ° /bin
          # é€™è§£æ±ºäº† gcc-ar æ‰¾ä¸åˆ° liblto_plugin.so çš„å•é¡Œ
          echo "$TARGET_DIR/bin" >> $GITHUB_PATH
          
          # å»ºç«‹åˆ¥åè»Ÿé€£çµ (å¦‚æžœåœ¨ bin å…§éƒ¨åç¨±ä¸å°æ‡‰)
          # ä¾‹å¦‚ï¼šMakefile å‘¼å« hanwckf-default-gccï¼Œä½†æª”æ¡ˆæ˜¯ mipsel-linux-uclibc-gcc
          cd "$TARGET_DIR/bin"
          
          # æ‰¾å‡ºå¯¦éš›çš„å‰ç¶´ (e.g., mipsel-linux-uclibc-)
          ACTUAL_PREFIX=$(ls *-gcc | head -n 1 | sed 's/gcc$//')
          EXPECTED_PREFIX="${TOOLCHAIN_TAG}-"
          
          if [ "$ACTUAL_PREFIX" != "$EXPECTED_PREFIX" ]; then
            echo ">>> Creating symlinks alias: $ACTUAL_PREFIX -> $EXPECTED_PREFIX"
            for file in ${ACTUAL_PREFIX}*; do
              new_name="${file/$ACTUAL_PREFIX/$EXPECTED_PREFIX}"
              ln -sf "$file" "$new_name"
            done
          fi
          
          # âš ï¸ å¦‚æžœæ˜¯å¤–éƒ¨ Toolchainï¼Œæˆ‘å€‘éœ€è¦ä¿®æ”¹ Makefile ä»¥é˜²æ­¢å®ƒå˜—è©¦é‡æ–°ä¸‹è¼‰
          # ä½†ä¸åˆªé™¤å…§å®¹ï¼Œåªæ˜¯è®“ toolchain ç›®æ¨™è®Šæˆç©ºæ“ä½œ
          echo ">>> Patching main Makefile to skip internal toolchain build for external mode..."
          cd ../../.. # å›žåˆ°æ ¹ç›®éŒ„
          # é€™è£¡æˆ‘å€‘ä¸åˆªé™¤ toolchain ä¾è³´ï¼Œè€Œæ˜¯ç¢ºä¿ç›®éŒ„å­˜åœ¨ï¼Œè®“ Make èªç‚ºå·²å®Œæˆ
          # å…·é«”çš„ Makefile é‚è¼¯é€šå¸¸æª¢æŸ¥ç›®éŒ„æ˜¯å¦å­˜åœ¨
          
      - name: 'ðŸ“ Customization & Configuration' 
        env:
          TNAME: ${{ inputs.target_select }}
        run: |
          # å°Žå‡º JSON è®Šæ•¸
          echo '${{ inputs.customization }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
              echo "${k^^}=$v" >> $GITHUB_ENV
          done
          
          # åŸ·è¡Œå®¢è£½åŒ–è…³æœ¬ (å¦‚æžœåœ¨ trunk ç›®éŒ„å…§)
          if [ -d "trunk/custom/scripts" ]; then
              chmod +x trunk/custom/scripts/*.sh
              # æ³¨æ„ï¼šå› ç‚ºä¸‹é¢æœƒåœ¨è®Šæ•¸è¨­ç½®å¾ŒåŸ·è¡Œï¼Œé€™è£¡å…ˆåƒ…åšæª”æ¡ˆæº–å‚™
              # å¯¦éš›åŸ·è¡Œå»ºè­°æ”¾åœ¨è…³æœ¬å…§
          fi
          
          # è¤‡è£½è¨­å®šæª”
          cd trunk
          if [ ! -f configs/templates/$TNAME.config ]; then
             echo "::error:: Config for $TNAME not found."
             exit 1
          fi
          cp -f configs/templates/$TNAME.config .config
          
          # Nano å„ªåŒ–
          if [ "${{ inputs.nanoversion }}" = "true" ]; then
            echo ">>> Applying Nano Optimization..."
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/g' .config
            for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" .config
            done
            # ... (ä¿ç•™æ‚¨çš„ Nano æ¨¡çµ„ç§»é™¤åˆ—è¡¨) ...
            modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED
              SMBD WINS SMBD_SYSLOG FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN SSWAN
              XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION TRANSMISSION_WEB_CONTROL ARIA QOS
              ARIA_CONTROL SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT
              SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE LRZSZ HTOP NANO IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY MENTOHUST
              FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER SMARTDNS
              ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER SQM WIREGUARD)
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" .config
            done
            keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE)
            for mod in "${keep_modules[@]}"; do
              sed -i "/CONFIG_FIRMWARE_INCLUDE_${mod}/d" .config 
              echo "CONFIG_FIRMWARE_INCLUDE_${mod}=y" >> .config
            done
          fi
          
          # ä¿®æ­£ BusyBox Makefile (æ‰€æœ‰æ¨¡å¼é€šç”¨)
          if [ -f "user/busybox/Makefile" ]; then
             sed -i '/EXTRA_LIBS =/c\EXTRA_LIBS =' user/busybox/Makefile
          fi

      - name: 'ðŸš€ Build Firmware'
        id: build_step
        env:
          TNAME: ${{ inputs.target_select }}
          TOOLCHAIN_TAG: ${{ inputs.toolchain_select }}
        run: |
          # åŸ·è¡Œå®¢è£½åŒ– IP/Wifi è¨­å®š (ä½¿ç”¨ ENV è®Šæ•¸)
          if [ -d "trunk/custom/scripts" ]; then
             bash trunk/custom/scripts/setip.sh "${LANIP}" trunk/user/shared/src/defaults.h trunk/user/www/dict/CN.dict || true
             bash trunk/custom/scripts/setaccount.sh "${SIGNACCOUNT}" "${SIGNPASSWORD}" trunk/user/shared/src/defaults.h || true
             bash trunk/custom/scripts/setwifi.sh "${WIFI2GSSID}" "${WIFI2GPSK}" "${WIFI5GSSID}" "${WIFI5GPSK}" trunk/user/shared/src/defaults.h || true
          fi

          echo ">>> Building $TNAME with toolchain $TOOLCHAIN_TAG"
          
          # ðŸŒŸ å¦‚æžœæ˜¯ mipsel-linux-muslï¼Œæˆ‘å€‘å®Œå…¨ä¸ä¿®æ”¹ Makefileï¼Œç›´æŽ¥åŸ·è¡Œ make
          # Makefile æœƒæª¢æ¸¬ trunk/toolchain-mipsel ä¸¦è‡ªå‹•ä¸‹è¼‰ crosstool-ng
          
          # ðŸŒŸ å¦‚æžœæ˜¯å¤–éƒ¨ Toolchainï¼Œæˆ‘å€‘å·²ç¶“å°‡ bin åŠ å…¥äº† PATHï¼Œ
          # ä¸¦ä¸” make æŒ‡ä»¤æœƒå‚³éž TOOLCHAIN=xxxï¼ŒMakefile æœƒåŽ»å‘¼å« xxx-gcc
          # å› ç‚ºå·²ç¶“åœ¨ PATH ä¸­ï¼Œæ‰€ä»¥èƒ½æ‰¾åˆ°ï¼Œä¸”èƒ½æ‰¾åˆ° liblto_plugin.so
          
          # å¼·åˆ¶æ¸…ç†å¯èƒ½å­˜åœ¨çš„èˆŠæ§‹å»º (é¿å…ç‰ˆæœ¬è¡çª)
          # make clean # è¦–æƒ…æ³é–‹å•Ÿï¼Œä½† CI ç’°å¢ƒé€šå¸¸æ˜¯ä¹¾æ·¨çš„

          make $TNAME TOOLCHAIN=$TOOLCHAIN_TAG
          
          # è™•ç†ç”¢ç‰©
          OUTPUT_NAME="$TNAME"
          [ "${{ inputs.nanoversion }}" = "true" ] && OUTPUT_NAME="${OUTPUT_NAME}-nano"
          
          image=$(ls trunk/images/*.trx 2>/dev/null | head -n 1)
          if [ ! -z "$image" ]; then
              FINAL_NAME="${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${{ env.BUILD_DATE }}.trx"
              mv "$image" "trunk/images/$FINAL_NAME"
              echo "âœ… Build success: trunk/images/$FINAL_NAME"
          else
              echo "::error:: Build finished but no .trx image found."
              exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.target_select }}-${{ inputs.toolchain_select }}-${{ env.BUILD_DATE }}
          path: trunk/images/*.trx

  publish:
    needs: [build]
    runs-on: ubuntu-22.04
    permissions: 
      contents: write 
    if: ${{ github.ref == 'refs/heads/main' }} 
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: 'Organize Artifacts' 
        run: |
          mkdir -p release_files
          find artifacts -name "*.trx" -exec cp {} release_files/ \;
      - name: 'Set Tag' 
        run: echo "TAG_ANME=$(date +%Y%m%d)-${{ github.run_number }}" >> $GITHUB_ENV
      - uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ env.TAG_ANME }}
      - uses: ncipollo/release-action@v1
        with:
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_ANME }}
          artifacts: "release_files/*.trx"
          allowUpdates: true
