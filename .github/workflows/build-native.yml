name: Build Single Target (Native Toolchain Only)

on:
Â  # æ”¯æ´ Push è§¸ç™¼
Â  push:
Â  Â  branches:
Â  Â  Â  - "*"
Â  # æ ¸å¿ƒï¼šæ‰‹å‹•é¸æ“‡å–®ä¸€ Job çš„è¼¸å…¥
Â  workflow_dispatch:
Â  Â  inputs:
Â  Â  Â  # 1. é¸æ“‡ç›®æ¨™æ©Ÿåž‹
Â  Â  Â  target_select:
Â  Â  Â  Â  description: "Select Target Router Model (Native Toolchain Only)"
Â  Â  Â  Â  required: true
Â  Â  Â  Â  type: choice
Â  Â  Â  Â  options:
Â  Â  Â  Â  Â  - K2P
Â  Â  Â  Â  Â  - K2P-NANO
Â  Â  Â  Â  Â  - K2P-USB
Â  Â  Â  Â  default: K2P
Â  Â  Â  Â Â 
Â  Â  Â  # 2. Toolchain å›ºå®šç‚ºåŽŸç”Ÿ
Â  Â  Â  toolchain_select:
Â  Â  Â  Â  description: "Compilation Toolchain (Locked to Native)"
Â  Â  Â  Â  required: true
Â  Â  Â  Â  type: choice
Â  Â  Â  Â  options:
Â  Â  Â  Â  Â  - mipsel-linux-muslÂ 
Â  Â  Â  Â  default: mipsel-linux-musl
Â  Â  Â  Â Â 
Â  Â  Â  # 3. é¸æ“‡ Nano é¸é … (åƒ…åŸ·è¡Œé…ç½®ç˜¦èº«)
Â  Â  Â  nanoversion:
Â  Â  Â  Â  description: "Apply Nano Optimization (Extreme slimming config)"
Â  Â  Â  Â  type: boolean
Â  Â  Â  Â  default: false
Â  Â  Â  Â Â 
Â  Â  Â  # 4. å®¢è£½åŒ– JSON
Â  Â  Â  customization:
Â  Â  Â  Â  description: 'Customization JSON'
Â  Â  Â  Â  required: true
Â  Â  Â  Â  type: string
Â  Â  Â  Â  default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

jobs:
Â  build:
Â  Â  runs-on: ubuntu-22.04
Â  Â  steps:
Â  Â  Â  - uses: actions/checkout@v3
Â  Â  Â Â 
Â  Â  Â  # ===============================================
Â  Â  Â  # é…ç½®ç’°å¢ƒ (Cache, Go, Node)
Â  Â  Â  # ===============================================
Â  Â  Â  - name: ðŸ’¾ Set up ccache (Compilation Cache)
Â  Â  Â  Â  uses: hendrikmuhs/ccache-action@v1.2
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  key: ${{ inputs.target_select }}-mipsel-linux-musl
Â  Â  Â  Â  Â Â 
Â  Â  Â  - name: âš™ï¸ Set up Go Environment
Â  Â  Â  Â  uses: actions/setup-go@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  go-version: '1.20'
Â  Â  Â  Â  Â  check-latest: true
Â  Â  Â  Â  Â  cache: false
Â  Â  Â  Â  Â Â 
Â  Â  Â  - name: âš™ï¸ Set up Node Environment
Â  Â  Â  Â  uses: actions/setup-node@v3
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  node-version: 18
Â  Â  Â  Â  Â  check-latest: true
Â  Â  Â  Â  Â Â 
Â  Â  Â  # ===============================================
Â  Â  Â  # æ­¥é©Ÿ 1: ä¾è³´å®‰è£
Â  Â  Â  # ===============================================
Â  Â  Â  - name: ðŸš€ Prepare (Fix Dependencies)
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  DEBIAN_FRONTEND: noninteractive
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  sudo apt update
Â  Â  Â  Â  Â  sudo apt install -y --no-install-recommends \
Â  Â  Â  Â  Â  Â  unzip cpio 7zip p7zip-full curl wget git \
Â  Â  Â  Â  Â  Â  build-essential fakeroot flex bison gawk gperf \
Â  Â  Â  Â  Â  Â  autotools-dev autoconf automake libtool-bin libltdl-dev \
Â  Â  Â  Â  Â  Â  python3-docutils autopoint gettext texinfo help2man \
Â  Â  Â  Â  Â  Â  zlib1g-dev liblzma-dev liblzo2-dev \
Â  Â  Â  Â  Â  Â  libgmp3-dev libmpc-dev libmpfr-dev \
Â  Â  Â  Â  Â  Â  libncurses5-dev xxd nano cmake pkg-config ccache jq

Â  Â  Â  Â  Â  # è¨­å®šå»ºç½®æ—¥æœŸè®Šæ•¸
Â  Â  Â  Â  Â  echo "BUILD_DATE=$(TZ='Asia/Taipei' date +%Y%m%d)" >> $GITHUB_ENV

Â  Â  Â  # ===============================================
Â  Â  Â  # æ­¥é©Ÿ 2: å®¢è£½åŒ–è¨­å®š (è®Šæ•¸åŒ¯å‡º)
Â  Â  Â  # ===============================================
Â  Â  Â  - name: âš™ï¸ Export Customization Variables
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  export_json() {
Â  Â  Â  Â  Â  Â  local JSON=$1
Â  Â  Â  Â  Â  Â  echo "$JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
Â  Â  Â  Â  Â  Â  Â  echo "${k^^}=$v" >> $GITHUB_ENV
Â  Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  export_json '${{ inputs.customization }}'
Â  Â  Â  Â  Â  echo "Customization variables exported to environment."

Â  Â  Â  # ===============================================
Â  Â  Â  # æ­¥é©Ÿ 3: æ ¸å¿ƒé…ç½®è™•ç† (è¤‡è£½é…ç½®æª”ï¼Œæ‡‰ç”¨ Nano å„ªåŒ–)
Â  Â  Â  # *USBéš”é›¢/å„ªåŒ–å·²è¢«ç§»é™¤*
Â  Â  Â  # ===============================================
Â  Â  Â  - name: ðŸ“ CORE:Configuration
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  TNAME: ${{ inputs.target_select }}
Â  Â  Â  Â  Â  NANO_OPT: ${{ inputs.nanoversion }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  cd trunk
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # 1. è¤‡è£½é…ç½®æª”æ¡ˆåˆ° trunk/.config
Â  Â  Â  Â  Â  echo ">>> 1. Copying base config: $TNAME.config -> .config"
Â  Â  Â  Â  Â  cp -f configs/templates/$TNAME.config .config
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # 2. åŸ·è¡Œæ¥µç«¯ Nano å„ªåŒ– (åƒ…åœ¨é¸æ“‡ Nano æ™‚åŸ·è¡Œé¡å¤–çš„é…ç½®ç˜¦èº«)
Â  Â  Â  Â  Â  if [ "$NANO_OPT" = "true" ]; then
Â  Â  Â  Â  Â  Â  echo ">>> ðŸš¨ Applying Nano Optimization for extreme slimming (Configuration only)..."
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  # ç§»é™¤æ–‡ä»¶ç³»çµ±æ”¯æŒ
Â  Â  Â  Â  Â  Â  for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
Â  Â  Â  Â  Â  Â  Â  sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" .config
Â  Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  # ç§»é™¤å¤§é‡æ¨¡çµ„
Â  Â  Â  Â  Â  Â  modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED
Â  Â  Â  Â  Â  Â  Â  SMBD WINS SMBD_SYSLOG FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN SSWAN
Â  Â  Â  Â  Â  Â  Â  XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION TRANSMISSION_WEB_CONTROL ARIA QOS
Â  Â  Â  Â  Â  Â  Â  ARIA_WEB_CONTROL SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT
Â  Â  Â  Â  Â  Â  Â  SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE LRZSZ HTOP NANO IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY MENTOHUST
Â  Â  Â  Â  Â  Â  Â  FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER SMARTDNS
Â  Â  Â  Â  Â  Â  Â  ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER SQM WIREGUARD)
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for mod in "${modules[@]}"; do
Â  Â  Â  Â  Â  Â  Â  sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" .config
Â  Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  # ç¢ºä¿ä¿ç•™æ¨¡çµ„
Â  Â  Â  Â  Â  Â  keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE)
Â  Â  Â  Â  Â  Â  for mod in "${keep_modules[@]}"; do
Â  Â  Â  Â  Â  Â  Â  sed -i "/CONFIG_FIRMWARE_INCLUDE_${mod}/d" .config
Â  Â  Â  Â  Â  Â  Â  echo "CONFIG_FIRMWARE_INCLUDE_${mod}=y" >> .config
Â  Â  Â  Â  Â  Â  done

Â  Â  Â  Â  Â  Â  echo "âœ… Extreme Nano Optimization configuration applied."
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  cd ..Â 
Â  Â  Â  Â  Â Â 
Â  Â  Â  # ===============================================
Â  Â  Â  # æ­¥é©Ÿ 4: åŸ·è¡Œå®¢è£½åŒ–è…³æœ¬ (æ‡‰ç”¨ JSON è®Šæ•¸åˆ° Source Code)
Â  Â  Â  # ===============================================
Â  Â  Â  - name: ðŸ“ Execute Customization Scripts (Apply to Source Code)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  if [ -d "trunk/custom/scripts" ]; then
Â  Â  Â  Â  Â  Â  Â  chmod +x trunk/custom/scripts/*.sh
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/src/defaults.h trunk/user/www/dict/CN.dict || true
Â  Â  Â  Â  Â  Â  Â  bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/src/defaults.h || true
Â  Â  Â  Â  Â  Â  Â  bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/src/defaults.h || true
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  echo "âœ… Custom settings applied to source code."
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  echo "âš ï¸ Custom scripts folder not found. Skipping customization."
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â Â 
Â  Â  Â  # ===============================================
Â  Â  Â  # æ­¥é©Ÿ 5: æº–å‚™ Host Tools (ä¿®å¾© mkimage Bug)
Â  Â  Â  # ===============================================
Â  Â  Â  - name: ðŸ”¨ Pre-Build Host Tools (Fix mkimage bug)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo ">>> ðŸ—ï¸ Building Host Tools..."
Â  Â  Â  Â  Â  cd trunk
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # ðŸš¨ mkimage.c çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²éŒ¯èª¤ä¿®å¾©
Â  Â  Â  Â  Â  if [ -f "tools/mkimage/mkimage.c" ]; then
Â  Â  Â  Â  Â  Â  Â  echo ">>> ðŸ”§ Patching tools/mkimage/mkimage.c..."
Â  Â  Â  Â  Â  Â  Â  sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' tools/mkimage/mkimage.c
Â  Â  Â  Â  Â  Â  Â  sed -i 's/"%d\.%d%c"/"%hhd.%hhd%c"/g' tools/mkimage/mkimage.c
Â  Â  Â  Â  Â  Â  Â  echo "âœ… mkimage.c patched."
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  make -C tools clean || true
Â  Â  Â  Â  Â  make -C tools
Â  Â  Â  Â  Â  echo "âœ… Host tools built successfully."
Â  Â  Â  Â  Â  cd ..Â 

Â  Â  Â  # ===============================================
Â  Â  Â  # æ­¥é©Ÿ 6: é–‹å§‹ç·¨è­¯ (æ¨¡æ“¬ Make é‚è¼¯ï¼Œç¢ºä¿é…ç½®ç”Ÿæ•ˆ)
Â  Â  Â  # ===============================================
Â  Â  Â  - name: 6.1 ðŸ—ï¸ Download Toolchain (Mimic make build step 1)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo ">>> Downloading Toolchain: ${{ inputs.toolchain_select }}"
Â  Â  Â  Â  Â  # è§£æ±ºæ‰¾ä¸åˆ° toolchain çš„å•é¡Œ
Â  Â  Â  Â  Â  sudo make -C toolchain download CT_TARGET=${{ inputs.toolchain_select }}

Â  Â  Â  - name: 6.2 ðŸ“ Insert Toolchain Paths & Reconfigure (Final Prep)
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  CONFIG_FILE="trunk/.config"
Â  Â  Â  Â  Â  TOOLCHAIN_DIR="$(pwd)/toolchain/toolchain-mipsel"
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if [ ! -f "$CONFIG_FILE" ]; then
Â  Â  Â  Â  Â  Â  Â echo "::error:: âŒ éŒ¯èª¤ï¼š$CONFIG_FILE æª”æ¡ˆä¸å­˜åœ¨ã€‚ç„¡æ³•å¯«å…¥ Toolchain é…ç½®ã€‚"
Â  Â  Â  Â  Â  Â  Â exit 1
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  echo ">>> Inserting mandatory Toolchain paths into $CONFIG_FILE."
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # å¯«å…¥äº¤å‰ç·¨è­¯å™¨è·¯å¾‘
Â  Â  Â  Â  Â  sudo bash -c "echo 'CONFIG_CROSS_COMPILER_ROOT=$TOOLCHAIN_DIR' >> $CONFIG_FILE"
Â  Â  Â  Â  Â  sudo bash -c "echo 'CONFIG_TOOLCHAIN=${{ inputs.toolchain_select }}' >> $CONFIG_FILE"
Â  Â  Â  Â  Â  sudo bash -c "echo 'CONFIG_CCACHE=y' >> $CONFIG_FILE"
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # åŒ¯å‡ºäº¤å‰ç·¨è­¯å™¨åˆ°ç’°å¢ƒè®Šæ•¸ PATHï¼Œè§£æ±º '-gcc: not found' éŒ¯èª¤
Â  Â  Â  Â  Â  echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH
Â  Â  Â  Â  Â  echo "âœ… Toolchain paths updated."
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # åŸ·è¡Œé…ç½®æ›´æ–°ï¼Œè™•ç†å…¶ä»–ç›¸ä¾æ€§ã€‚
Â  Â  Â  Â  Â  echo ">>> ðŸ”„ Forcing configuration update across all Makefiles (Final Check)..."
Â  Â  Â  Â  Â  sudo make -C trunk config || sudo make -C trunk olddefconfig || true
Â  Â  Â  Â  Â  echo "âœ… Configuration update attempted."


Â  Â  Â  - name: 6.3 ðŸ§± Start Core Compilation (Mimic make build step 2)
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  TNAME: ${{ inputs.target_select }}
Â  Â  Â  Â  Â  NANO_OPT: ${{ inputs.nanoversion }}
Â  Â  Â  Â  Â  BUILD_DATE: ${{ env.BUILD_DATE }}
Â  Â  Â  Â  Â  # ç¢ºä¿ç·¨è­¯å™¨è·¯å¾‘è¢«æ˜Žç¢ºåŒ¯å…¥çµ¦ make -C trunk
Â  Â  Â  Â  Â  CROSS_COMPILE: ${{ inputs.toolchain_select }}-
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo ">>> Starting kernel and user space compilation using 'sudo make -C trunk'..."
Â  Â  Â  Â  Â  sudo make -C trunk
Â  Â  Â  Â  Â  mkdir -p trunk/imagesÂ 

Â  Â  Â  - name: 6.4 ðŸ“¦ Finalize and Rename Firmware
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  TNAME: ${{ inputs.target_select }}
Â  Â  Â  Â  Â  NANO_OPT: ${{ inputs.nanoversion }}
Â  Â  Â  Â  Â  BUILD_DATE: ${{ env.BUILD_DATE }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  OUTPUT_NAME="${{ env.TNAME }}"
Â  Â  Â  Â  Â  [ "${{ env.NANO_OPT }}" = "true" ] && OUTPUT_NAME="${OUTPUT_NAME}-nano"
Â  Â  Â  Â  Â  TOOLCHAIN_TAG=${{ inputs.toolchain_select }}
Â  Â  Â  Â  Â  DATE=${{ env.BUILD_DATE }}
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  image=$(ls trunk/images/*.trx 2>/dev/null | head -n 1)Â 
Â  Â  Â  Â  Â  if [ ! -z "$image" ]; then
Â  Â  Â  Â  Â  Â  Â  # è§£æ±º Permission denied
Â  Â  Â  Â  Â  Â  Â  sudo mv "$image" "trunk/images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx"
Â  Â  Â  Â  Â  Â  Â  echo "âœ… Build success for $TNAME. Saved as: trunk/images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx"
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  echo "::error:: âŒ æ‰¾ä¸åˆ°è¼¸å‡ºæª”æ¡ˆ (*.trx)ã€‚è«‹æª¢æŸ¥ç·¨è­¯æ—¥èªŒæ˜¯å¦æœ‰éŒ¯èª¤ã€‚"
Â  Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi

Â  Â  Â  # ===============================================
Â  Â  Â  # è¼¸å‡ºèˆ‡ç™¼å¸ƒ
Â  Â  Â  # ===============================================
Â  Â  Â  - uses: actions/upload-artifact@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  name: ${{ inputs.target_select }}-${{ inputs.toolchain_select }}-${{ env.BUILD_DATE }}
Â  Â  Â  Â  Â  path: trunk/images/*.trx

Â  publish:
Â  Â  needs: [build]
Â  Â  runs-on: ubuntu-22.04
Â  Â  if: ${{ github.ref == 'refs/heads/main' }}
Â  Â  steps:
Â  Â  Â  - uses: actions/checkout@v3
Â  Â  Â Â 
Â  Â  Â  - uses: actions/download-artifact@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  path: artifacts

Â  Â  Â  - name: Organize Artifacts
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  mkdir -p release_files
Â  Â  Â  Â  Â  find artifacts -name "*.trx" -exec cp {} release_files/ \;
Â  Â  Â  Â  Â  ls -l release_files/

Â  Â  Â  - name: Set Tag Name
Â  Â  Â  Â  run: echo "TAG_ANME=$(date +%Y%m%d)" >> $GITHUB_ENV
Â  Â  Â  Â Â 
Â  Â  Â  - uses: rickstaa/action-create-tag@v1
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  tag: ${{ env.TAG_ANME }}
Â  Â  Â  Â  Â  force_push_tag: true
Â  Â  Â  Â  Â Â 
Â  Â  Â  - uses: ncipollo/release-action@v1
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  commit: ${{ github.sha }}
Â  Â  Â  Â  Â  tag: ${{ env.TAG_ANME }}
Â  Â  Â  Â  Â  artifacts: "release_files/*.trx"
Â  Â  Â  Â  Â  allowUpdates: true
