name: Build Single Target (Native Toolchain Only)

on:
  # æ”¯æ´ Push è§¸ç™¼
  push:
    branches:
      - "*"
  # æ ¸å¿ƒï¼šæ‰‹å‹•é¸æ“‡å–®ä¸€ Job çš„è¼¸å…¥
  workflow_dispatch:
    inputs:
      # 1. é¸æ“‡ç›®æ¨™æ©Ÿåž‹
      target_select:
        description: "Select Target Router Model (Native Toolchain Only)"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
        default: K2P
        
      # 2. Toolchain å›ºå®šç‚ºåŽŸç”Ÿ
      toolchain_select:
        description: "Compilation Toolchain (Locked to Native)"
        required: true
        type: choice
        options:
          - mipsel-linux-musl 
        default: mipsel-linux-musl
        
      # 3. é¸æ“‡ Nano é¸é … (åƒ…åŸ·è¡Œé…ç½®ç˜¦èº«)
      nanoversion:
        description: "Apply Nano Optimization (Extreme slimming config)"
        type: boolean
        default: false
        
      # 4. å®¢è£½åŒ– JSON
      customization:
        description: 'Customization JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      
      # ===============================================
      # é…ç½®ç’°å¢ƒ (Cache, Go, Node)
      # ===============================================
      - name: ðŸ’¾ Set up ccache (Compilation Cache)
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ inputs.target_select }}-mipsel-linux-musl
          
      - name: âš™ï¸ Set up Go Environment
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'
          check-latest: true
          cache: false
          
      - name: âš™ï¸ Set up Node Environment
        uses: actions/setup-node@v3
        with:
          node-version: 18
          check-latest: true
          
      # ===============================================
      # æ­¥é©Ÿ 1: ä¾è³´å®‰è£
      # ===============================================
      - name: ðŸš€ Prepare (Fix Dependencies)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git \
            build-essential fakeroot flex bison gawk gperf \
            autotools-dev autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq

          # è¨­å®šå»ºç½®æ—¥æœŸè®Šæ•¸
          echo "BUILD_DATE=$(TZ='Asia/Taipei' date +%Y%m%d)" >> $GITHUB_ENV

      # ===============================================
      # æ­¥é©Ÿ 2: å®¢è£½åŒ–è¨­å®š (è®Šæ•¸åŒ¯å‡º)
      # ===============================================
      - name: âš™ï¸ Export Customization Variables
        run: |
          export_json() {
            local JSON=$1
            echo "$JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
              echo "${k^^}=$v" >> $GITHUB_ENV
            done
          }
          export_json '${{ inputs.customization }}'
          echo "Customization variables exported to environment."

      # ===============================================
      # æ­¥é©Ÿ 3: æ ¸å¿ƒé…ç½®è™•ç† (è¤‡è£½é…ç½®æª”ï¼Œæ‡‰ç”¨ Nano å„ªåŒ–èˆ‡ USB éš”é›¢)
      # ===============================================
      - name: ðŸ“ CORE: Configuration & USB Isolation
        env:
          TNAME: ${{ inputs.target_select }}
          NANO_OPT: ${{ inputs.nanoversion }}
        run: |
          cd trunk
          
          # 1. è¤‡è£½é…ç½®æª”æ¡ˆåˆ° trunk/.config
          echo ">>> 1. Copying base config: $TNAME.config -> .config"
          cp -f configs/templates/$TNAME.config .config
          
          # 2. ðŸš¨ æ ¸å¿ƒä¿®æ­£ï¼šæ ¹æ“š Target åç¨±ï¼Œå¼·åˆ¶éš”é›¢ USB ç¨‹å¼ç¢¼
          #    (è§£æ±º K2P å’Œ K2P-NANO ç·¨è­¯å¤±æ•—çš„å•é¡Œ)
          if [[ ! "${TNAME}" =~ "USB" ]]; then
              echo ">>> âŒ NON-USB Target selected (${TNAME}). Forcing removal of dependent userland source files..."
              
              # å¼·åˆ¶é—œé–‰æ ¸å¿ƒ USB æ”¯æ´ (é…ç½®å±¤ï¼Œç¢ºä¿é…ç½®ä¸€è‡´)
              echo ">>> â›” Removing Core USB and Storage Support in .config (Config Layer)..."
              usb_configs=(USB_SUPPORT USB_STORAGE USB_OHCI_HCD USB_EHCI_HCD SCSI_DISK)
              for usb in "${usb_configs[@]}"; do
                  sed -i "/CONFIG_${usb}/d" .config 
                  echo "CONFIG_${usb}=n" >> .config 
              done

              # å¼·åˆ¶ç§»é™¤ä½¿ç”¨è€…ç©ºé–“ä¸­ï¼Œä¾è³´å·²ç¦ç”¨æ ¸å¿ƒ USB æ”¯æ´çš„åŽŸå§‹ç¢¼
              for file in hotplug_usb.c usb_modem.c services_usb.c; do
                  if [ -f "user/rc/$file" ]; then
                      sudo rm -f user/rc/$file 
                      echo "Removed user/rc/$file"
                  fi
              done
              echo "âœ… Userland USB files purged and config disabled."
          fi
          
          # 3. åŸ·è¡Œæ¥µç«¯ Nano å„ªåŒ– (åƒ…åœ¨é¸æ“‡ Nano æ™‚åŸ·è¡Œé¡å¤–çš„é…ç½®ç˜¦èº«)
          if [ "$NANO_OPT" = "true" ]; then
            echo ">>> ðŸš¨ Applying Nano Optimization for extreme slimming (Configuration only)..."
            
            # ç§»é™¤æ–‡ä»¶ç³»çµ±æ”¯æŒ
            for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" .config
            done
            
            # ç§»é™¤å¤§é‡æ¨¡çµ„
            modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED
              SMBD WINS SMBD_SYSLOG FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN SSWAN
              XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION TRANSMISSION_WEB_CONTROL ARIA QOS
              ARIA_WEB_CONTROL SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT
              SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE LRZSZ HTOP NANO IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY MENTOHUST
              FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER SMARTDNS
              ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER SQM WIREGUARD)
            
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" .config
            done
            
            # ç¢ºä¿ä¿ç•™æ¨¡çµ„
            keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE)
            for mod in "${keep_modules[@]}"; do
              sed -i "/CONFIG_FIRMWARE_INCLUDE_${mod}/d" .config
              echo "CONFIG_FIRMWARE_INCLUDE_${mod}=y" >> .config
            done

            echo "âœ… Extreme Nano Optimization configuration applied."
          fi
          
          cd .. 
          
      # ===============================================
      # æ­¥é©Ÿ 4: åŸ·è¡Œå®¢è£½åŒ–è…³æœ¬ (æ‡‰ç”¨ JSON è®Šæ•¸åˆ° Source Code)
      # ===============================================
      - name: ðŸ“ Execute Customization Scripts (Apply to Source Code)
        run: |
          if [ -d "trunk/custom/scripts" ]; then
              chmod +x trunk/custom/scripts/*.sh
              
              bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/src/defaults.h trunk/user/www/dict/CN.dict || true
              bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/src/defaults.h || true
              bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/src/defaults.h || true
              
              echo "âœ… Custom settings applied to source code."
          else
              echo "âš ï¸ Custom scripts folder not found. Skipping customization."
          fi
          
      # ===============================================
      # æ­¥é©Ÿ 5: æº–å‚™ Host Tools (ä¿®å¾© mkimage Bug)
      # ===============================================
      - name: ðŸ”¨ Pre-Build Host Tools (Fix mkimage bug)
        run: |
          echo ">>> ðŸ—ï¸ Building Host Tools..."
          cd trunk
          
          # ðŸš¨ mkimage.c çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²éŒ¯èª¤ä¿®å¾©
          if [ -f "tools/mkimage/mkimage.c" ]; then
              echo ">>> ðŸ”§ Patching tools/mkimage/mkimage.c..."
              sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' tools/mkimage/mkimage.c
              sed -i 's/"%d\.%d%c"/"%hhd.%hhd%c"/g' tools/mkimage/mkimage.c
              echo "âœ… mkimage.c patched."
          fi

          make -C tools clean || true
          make -C tools
          echo "âœ… Host tools built successfully."
          cd .. 

      # ===============================================
      # æ­¥é©Ÿ 6: é–‹å§‹ç·¨è­¯ (æ¨¡æ“¬ Make é‚è¼¯ï¼Œç¢ºä¿é…ç½®ç”Ÿæ•ˆ)
      # ===============================================
      - name: 6.1 ðŸ—ï¸ Download Toolchain (Mimic make build step 1)
        run: |
          echo ">>> Downloading Toolchain: ${{ inputs.toolchain_select }}"
          # è§£æ±ºæ‰¾ä¸åˆ° toolchain çš„å•é¡Œ
          sudo make -C toolchain download CT_TARGET=${{ inputs.toolchain_select }}

      - name: 6.2 ðŸ“ Insert Toolchain Paths & Reconfigure (Final Prep)
        run: |
          CONFIG_FILE="trunk/.config"
          TOOLCHAIN_DIR="$(pwd)/toolchain/toolchain-mipsel"
          
          if [ ! -f "$CONFIG_FILE" ]; then
             echo "::error:: âŒ éŒ¯èª¤ï¼š$CONFIG_FILE æª”æ¡ˆä¸å­˜åœ¨ã€‚ç„¡æ³•å¯«å…¥ Toolchain é…ç½®ã€‚"
             exit 1
          fi

          echo ">>> Inserting mandatory Toolchain paths into $CONFIG_FILE."
          
          # å¯«å…¥äº¤å‰ç·¨è­¯å™¨è·¯å¾‘
          sudo bash -c "echo 'CONFIG_CROSS_COMPILER_ROOT=$TOOLCHAIN_DIR' >> $CONFIG_FILE"
          sudo bash -c "echo 'CONFIG_TOOLCHAIN=${{ inputs.toolchain_select }}' >> $CONFIG_FILE"
          sudo bash -c "echo 'CONFIG_CCACHE=y' >> $CONFIG_FILE"
          
          # åŒ¯å‡ºäº¤å‰ç·¨è­¯å™¨åˆ°ç’°å¢ƒè®Šæ•¸ PATHï¼Œè§£æ±º '-gcc: not found' éŒ¯èª¤
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH
          echo "âœ… Toolchain paths updated."
          
          # åŸ·è¡Œé…ç½®æ›´æ–°ï¼Œè™•ç†å…¶ä»–ç›¸ä¾æ€§ã€‚
          echo ">>> ðŸ”„ Forcing configuration update across all Makefiles (Final Check)..."
          sudo make -C trunk config || sudo make -C trunk olddefconfig || true
          echo "âœ… Configuration update attempted."


      - name: 6.3 ðŸ§± Start Core Compilation (Mimic make build step 2)
        env:
          TNAME: ${{ inputs.target_select }}
          NANO_OPT: ${{ inputs.nanoversion }}
          BUILD_DATE: ${{ env.BUILD_DATE }}
          # ç¢ºä¿ç·¨è­¯å™¨è·¯å¾‘è¢«æ˜Žç¢ºåŒ¯å…¥çµ¦ make -C trunk
          CROSS_COMPILE: ${{ inputs.toolchain_select }}-
        run: |
          echo ">>> Starting kernel and user space compilation using 'sudo make -C trunk'..."
          sudo make -C trunk
          mkdir -p trunk/images 

      - name: 6.4 ðŸ“¦ Finalize and Rename Firmware
        env:
          TNAME: ${{ inputs.target_select }}
          NANO_OPT: ${{ inputs.nanoversion }}
          BUILD_DATE: ${{ env.BUILD_DATE }}
        run: |
          OUTPUT_NAME="${{ env.TNAME }}"
          [ "${{ env.NANO_OPT }}" = "true" ] && OUTPUT_NAME="${OUTPUT_NAME}-nano"
          TOOLCHAIN_TAG=${{ inputs.toolchain_select }}
          DATE=${{ env.BUILD_DATE }}
          
          image=$(ls trunk/images/*.trx 2>/dev/null | head -n 1) 
          if [ ! -z "$image" ]; then
              # è§£æ±º Permission denied
              sudo mv "$image" "trunk/images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx"
              echo "âœ… Build success for $TNAME. Saved as: trunk/images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx"
          else
              echo "::error:: âŒ æ‰¾ä¸åˆ°è¼¸å‡ºæª”æ¡ˆ (*.trx)ã€‚è«‹æª¢æŸ¥ç·¨è­¯æ—¥èªŒæ˜¯å¦æœ‰éŒ¯èª¤ã€‚"
              exit 1
          fi

      # ===============================================
      # è¼¸å‡ºèˆ‡ç™¼å¸ƒ
      # ===============================================
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.target_select }}-${{ inputs.toolchain_select }}-${{ env.BUILD_DATE }}
          path: trunk/images/*.trx

  publish:
    needs: [build]
    runs-on: ubuntu-22.04
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize Artifacts
        run: |
          mkdir -p release_files
          find artifacts -name "*.trx" -exec cp {} release_files/ \;
          ls -l release_files/

      - name: Set Tag Name
        run: echo "TAG_ANME=$(date +%Y%m%d)" >> $GITHUB_ENV
        
      - uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ env.TAG_ANME }}
          force_push_tag: true
          
      - uses: ncipollo/release-action@v1
        with:
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_ANME }}
          artifacts: "release_files/*.trx"
          allowUpdates: true
