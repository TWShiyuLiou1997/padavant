name: Build Single Target (Native Toolchain Only)

on:
  push:
    branches:
      - "*"
  # æ ¸å¿ƒï¼šæ‰‹å‹•é¸æ“‡å–®ä¸€ Job çš„è¼¸å…¥
  workflow_dispatch:
    inputs:
      # 1. é¸æ“‡ç›®æ¨™æ©Ÿåž‹
      target_select:
        description: "Select Target Router Model (Native Toolchain Only)"
        required: true
        type: choice
        options:
          - K2P
          - K2P-NANO
          - K2P-USB
        default: K2P
        
      # 2. Toolchain å›ºå®šç‚ºåŽŸç”Ÿ
      toolchain_select:
        description: "Compilation Toolchain (Locked to Native)"
        required: true
        type: choice
        options:
          - mipsel-linux-musl 
        default: mipsel-linux-musl
        
      # 3. é¸æ“‡ Nano é¸é …
      nanoversion:
        description: "Apply Nano Optimization (Extreme slimming config)"
        type: boolean
        default: false
        
      # 4. å®¢è£½åŒ– JSON
      customization:
        description: 'Customization JSON'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      
      - name: ðŸ’¾ Set up ccache (Compilation Cache)
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ inputs.target_select }}-mipsel-linux-musl
          
      - name: âš™ï¸ Set up Go Environment
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'
          check-latest: true
          cache: false
          
      - name: âš™ï¸ Set up Node Environment
        uses: actions/setup-node@v3
        with:
          node-version: 18
          check-latest: true
          
      # ===============================================
      # æ­¥é©Ÿ 1: ä¾è³´å®‰è£
      # ===============================================
      - name: ðŸš€ Prepare (Fix Dependencies)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            unzip cpio 7zip p7zip-full curl wget git \
            build-essential fakeroot flex bison gawk gperf \
            autotools-dev autoconf automake libtool-bin libltdl-dev \
            python3-docutils autopoint gettext texinfo help2man \
            zlib1g-dev liblzma-dev liblzo2-dev \
            libgmp3-dev libmpc-dev libmpfr-dev \
            libncurses5-dev xxd nano cmake pkg-config ccache jq

          # è¨­å®šå»ºç½®æ—¥æœŸè®Šæ•¸
          echo "BUILD_DATE=$(TZ='Asia/Taipei' date +%Y%m%d)" >> $GITHUB_ENV

      # ===============================================
      # æ­¥é©Ÿ 2: å®¢è£½åŒ–è¨­å®š (è®Šæ•¸åŒ¯å‡º)
      # ===============================================
      - name: âš™ï¸ Export Customization Variables
        run: |
          export_json() {
            local JSON=$1
            echo "$JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
              echo "${k^^}=$v" >> $GITHUB_ENV
            done
          }
          export_json '${{ inputs.customization }}'
          echo "Customization variables exported to environment."

      # ===============================================
      # æ­¥é©Ÿ 3: æ ¸å¿ƒé…ç½®è™•ç† (è¤‡è£½é…ç½®æª”ï¼Œæ‡‰ç”¨ Nano å„ªåŒ–èˆ‡ USB ç§»é™¤)
      # ===============================================
      - name: ðŸ“ CORE:Configuration Setup & Nano Optimization (USB Fix)
        env:
          TNAME: ${{ inputs.target_select }}
          NANO_OPT: ${{ inputs.nanoversion }}
        run: |
          # 1. é€²å…¥ trunk ç›®éŒ„
          cd trunk
          
          # 2. è¤‡è£½é…ç½®æª”æ¡ˆåˆ° trunk/.config (ç¢ºä¿é…ç½®æª”å­˜åœ¨)
          echo ">>> 1. Copying base config: $TNAME.config -> .config"
          cp -f configs/templates/$TNAME.config .config
          
          # 3. Nano å„ªåŒ–é‚è¼¯ (å¼·åˆ¶ç§»é™¤æ ¸å¿ƒ USB å’Œä¸éœ€è¦çš„æ‡‰ç”¨å±¤æ¨¡çµ„)
          if [ "$NANO_OPT" = "true" ]; then
            echo ">>> ðŸš¨ Applying Nano Optimization for extreme slimming..."
            
            # æ ¸å¿ƒä¿®æ­£ï¼šå¼·åˆ¶ç§»é™¤æ ¸å¿ƒ USB æ”¯æ´ (The 7MB Fix)
            echo ">>> â›” Removing Core USB and Storage Support..."
            usb_configs=(USB_SUPPORT USB_STORAGE USB_OHCI_HCD USB_EHCI_HCD SCSI_DISK)
            for usb in "${usb_configs[@]}"; do
              sed -i "/CONFIG_${usb}/d" .config 
              echo "CONFIG_${usb}=n" >> .config 
            done
            
            # ç§»é™¤æ–‡ä»¶ç³»çµ±æ”¯æŒ
            for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" .config
            done
            
            # ç§»é™¤å¤§é‡æ¨¡çµ„
            modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED
              SMBD WINS SMBD_SYSLOG FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN SSWAN
              XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION TRANSMISSION_WEB_CONTROL ARIA QOS
              ARIA_WEB_CONTROL SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT
              SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE LRZSZ HTOP NANO IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY MENTOHUST
              FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER SMARTDNS
              ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER SQM WIREGUARD)
            
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" .config
            done
            
            # ç¢ºä¿ä¿ç•™æ¨¡çµ„ (åŒ…å« OPENSSL_EXE)
            keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE)
            for mod in "${keep_modules[@]}"; do
              sed -i "/CONFIG_FIRMWARE_INCLUDE_${mod}/d" .config
              echo "CONFIG_FIRMWARE_INCLUDE_${mod}=y" >> .config
            done

            echo "âœ… Nano Optimization applied to .config."
          fi
          
          # 4. é€€å‡º trunkï¼Œè®“å¾ŒçºŒæ­¥é©Ÿåœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œ
          cd .. 
          
      # ===============================================
      # æ­¥é©Ÿ 4: åŸ·è¡Œå®¢è£½åŒ–è…³æœ¬ (æ‡‰ç”¨ JSON è®Šæ•¸åˆ° Source Code)
      # ===============================================
      - name: ðŸ“ Execute Customization Scripts (Apply to Source Code)
        run: |
          if [ -d "trunk/custom/scripts" ]; then
              chmod +x trunk/custom/scripts/*.sh
              
              bash trunk/custom/scripts/setip.sh "${{ env.LANIP }}" trunk/user/shared/src/defaults.h trunk/user/www/dict/CN.dict || true
              bash trunk/custom/scripts/setaccount.sh "${{ env.SIGNACCOUNT }}" "${{ env.SIGNPASSWORD }}" trunk/user/shared/src/defaults.h || true
              bash trunk/custom/scripts/setwifi.sh "${{ env.WIFI2GSSID }}" "${{ env.WIFI2GPSK }}" "${{ env.WIFI5GSSID }}" "${{ env.WIFI5GPSK }}" trunk/user/shared/src/defaults.h || true
              
              echo "âœ… Custom settings applied to source code."
          else
              echo "âš ï¸ Custom scripts folder not found. Skipping customization."
          fi
          
      # ===============================================
      # æ­¥é©Ÿ 5: æº–å‚™ Host Tools (ä¿®å¾© mkimage Bug)
      # ===============================================
      - name: ðŸ”¨ Pre-Build Host Tools (Fix mkimage bug)
        run: |
          echo ">>> ðŸ—ï¸ Building Host Tools..."
          cd trunk
          
          # ðŸš¨ mkimage.c çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²éŒ¯èª¤ä¿®å¾©
          if [ -f "tools/mkimage/mkimage.c" ]; then
              echo ">>> ðŸ”§ Patching tools/mkimage/mkimage.c..."
              sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' tools/mkimage/mkimage.c
              sed -i 's/"%d\.%d%c"/"%hhd.%hhd%c"/g' tools/mkimage/mkimage.c
              echo "âœ… mkimage.c patched."
          fi

          make -C tools clean || true
          make -C tools
          echo "âœ… Host tools built successfully."
          cd .. # åˆ‡å›žæ ¹ç›®éŒ„

      # ===============================================
      # æ­¥é©Ÿ 5.5: ä¿®æ­£æ ¹ç›®éŒ„ç·¨è­¯è…³æœ¬æ¬Šé™ (è§£æ±º No such file)
      # ===============================================
      - name: ðŸ”¨ Fix Root Directory Script Permissions
        run: |
          echo ">>> Setting permissions for root scripts (clear_tree, build_firmware_modify)..."
          # è…³æœ¬åœ¨æ ¹ç›®éŒ„ï¼Œåœ¨æ­¤è³¦äºˆæ¬Šé™
          chmod +x clear_tree build_firmware_modify
          echo "âœ… Root scripts permissions set."

      # ===============================================
      # æ­¥é©Ÿ 6: é–‹å§‹ç·¨è­¯ (åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œ Padavan è…³æœ¬)
      # ===============================================
      - name: ðŸ—ï¸ Execute Padavan Build Script
        env:
          TNAME: ${{ inputs.target_select }}
          NANO_OPT: ${{ inputs.nanoversion }}
          BUILD_DATE: ${{ env.BUILD_DATE }}
        run: |
          mkdir -p trunk/images
          echo "Current directory for compilation: $(pwd)"
          
          # 1. åŸ·è¡Œæ¸…ç† (è…³æœ¬ä½æ–¼æ ¹ç›®éŒ„)
          echo ">>> Starting clean tree..."
          sudo ./clear_tree || true
          
          # 2. åŸ·è¡Œ Padavan å°ˆæ¡ˆæ­£ç¢ºçš„ç·¨è­¯è…³æœ¬
          echo ">>> Starting Padavan build process..."
          # Padavan çš„ build_firmware_modify è…³æœ¬æœƒå¾žæ ¹ç›®éŒ„é–‹å§‹ç·¨è­¯
          sudo ./build_firmware_modify $TNAME 0 
          
          # 3. ç·¨è­¯å®Œæˆï¼Œè™•ç†è¼¸å‡ºæª”æ¡ˆåç¨±
          OUTPUT_NAME="$TNAME"
          [ "$NANO_OPT" = "true" ] && OUTPUT_NAME="${OUTPUT_NAME}-nano"
          TOOLCHAIN_TAG=${{ inputs.toolchain_select }}
          DATE=${{ env.BUILD_DATE }}
          
          # 4. ç§»å‹•è¼¸å‡ºæª”æ¡ˆ (è¼¸å‡ºä½æ–¼ trunk/images/ å…§)
          cd trunk # å¿…é ˆé€²å…¥ trunk æ‰èƒ½æ‰¾åˆ° images ç›®éŒ„
          image=$(ls images/*.trx 2>/dev/null | head -n 1) 
          if [ ! -z "$image" ]; then
              mv $image images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx
              echo "âœ… Build success for $TNAME. Saved as: images/${OUTPUT_NAME}-${TOOLCHAIN_TAG}-${DATE}.trx"
          else
              echo "::error:: âŒ æ‰¾ä¸åˆ°è¼¸å‡ºæª”æ¡ˆ (*.trx)ã€‚è«‹æª¢æŸ¥ç·¨è­¯æ—¥èªŒæ˜¯å¦æœ‰éŒ¯èª¤ã€‚"
              exit 1
          fi
          
          # 5. å¿…é ˆåˆ‡å›žæ ¹ç›®éŒ„ï¼Œè®“å¾ŒçºŒ upload æ­¥é©Ÿèƒ½æ‰¾åˆ° trunk/images/ 
          cd .. 

      # ä½¿ç”¨ actions/upload-artifact@v4
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.target_select }}-${{ inputs.toolchain_select }}-${{ env.BUILD_DATE }}
          path: trunk/images/*.trx

  # ===============================================
  # ç™¼å¸ƒ Job
  # ===============================================
  publish:
    needs: [build]
    runs-on: ubuntu-22.04
    # åƒ…åœ¨ main åˆ†æ”¯ push æ™‚ç™¼å¸ƒ
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v3
      
      # ä½¿ç”¨ actions/download-artifact@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize Artifacts
        run: |
          mkdir -p release_files
          find artifacts -name "*.trx" -exec cp {} release_files/ \;
          ls -l release_files/

      - name: Set Tag Name
        run: echo "TAG_ANME=$(date +%Y%m%d)" >> $GITHUB_ENV
        
      - uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ env.TAG_ANME }}
          force_push_tag: true
          
      - uses: ncipollo/release-action@v1
        with:
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_ANME }}
          artifacts: "release_files/*.trx"
          allowUpdates: true
